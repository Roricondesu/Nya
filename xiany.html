<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>织谱·天弦</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <script src="https://unpkg.com/d3-milestones/build/d3-milestones.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/d3-milestones/build/d3-milestones.css">
    <style>
        @import url('https://fontsapi.zeoseven.com/309/main/result.css');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* 音乐可视化器样式 */
        .visualizer-container {
            position: fixed;
            bottom: -10px;
            left: -30px;
            width: 100%;
            height: 100px;
            z-index: 9;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #visualizer {
            width: 90%;
            height: 80px;
        }
        
        /* 底部按钮样式 */
        .bottom-buttons {
            position: fixed;
            left: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .bottom-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.7);
            color: #1a0b4d;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .bottom-btn:hover {
            background: #d4af37;
            transform: scale(1.1);
        }
        
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: linear-gradient(to bottom, #1a0b4d, #4b0082);
            color: #d4af37;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }
        
        h1, h3, h4 {
            font-family: "KingHwa_OldSong", serif;
            font-weight: normal;
        }
        
        h2 {
            font-family: "KingHwa_OldSong", serif;
            font-weight: normal;
            font-size: 3rem; /* 放大h2字号 */
            transform: translateY(-50px); /* 向上移动10% */
            animation: floatText 3s ease-in-out infinite; /* 添加浮动动画 */
        }

        /* 定义浮动动画 */
        @keyframes floatText {
            0% {
                transform: translateY(-50px);
            }
            50% {
                transform: translateY(-40px);
            }
            100% {
                transform: translateY(-50px);
            }
        }
         
        .container {
            width: 100%;
            min-height: 100vh;
            position: relative;
        }
        
        /* 标题样式 */
        .main-title {
            position: fixed;
            top: 20px;
            left: 20px;
            font-family: "KingHwa_OldSong", serif;
            font-size: 3rem;
            color: #d4af37;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
            z-index: 100;
            opacity: 0; /* 初始状态为不可见 */
            transform: translateY(-20px); /* 初始位置向上偏移 */
        }
        
        
        .main-title span {
            display: block;
            line-height: 1;
        }
        
        .main-title .dot {
            color: #ff6b6b;
            font-size: 4rem;
            line-height: 0.8;
        }
        
        /* 导航时间线 */
        .timeline-nav {
            position: fixed;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 900;
            width: 120px;
            height: 70vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .timeline-line {
            position: absolute;
            left: 40px;
            top: 0;
            width: 4px;
            height: 100%;
            background: rgba(212, 175, 55, 0.3);
            z-index: -1;
            border-radius: 2px;
        }
        
        .timeline-wave {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0.2;
            z-index: -2;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 60px;
            cursor: pointer;
            color: rgba(212, 175, 55, 0.7);
            transition: all 0.3s ease;
            font-family: "KingHwa_OldSong", serif;
            font-size: 1.1rem;
            text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
            opacity: 0.7;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 36px;
            top: 50%;
            transform: translateY(-50%) rotate(45deg); /* 旋转 22.5 度使八边形正立 */
            width: 12px;
            height: 12px;
            background: #d4af37;
            transition: all 0.3s ease;
            clip-path: polygon(29.29% 0%, 70.71% 0%, 100% 29.29%, 100% 70.71%, 70.71% 100%, 29.29% 100%, 0% 70.71%, 0% 29.29%); /* 使用 clip-path 创建正八边形 */
        }
        
        .timeline-item.active {
            opacity: 1;
            color: #d4af37;
            transform: scale(1.05);
        }
        
        .timeline-item.active::before {
            background: #ffe26e;
            box-shadow: 0 0 10px #ff6b6b;
            transform: translateY(-50%) scale(1.3);
        }
        
        /* 主内容区域 */
        .main-content {
            margin-left: 180px;
            padding: 100px 50px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            opacity: 0; /* 初始状态为不可见 */
        }
        
        /* 三栏布局 */
        .page-section {
            width: 100%;
            min-height: 100vh;
            display: flex;
            margin-bottom: 50px;
            position: relative;
            opacity: 0; /* 初始状态为不可见 */
            transform: translateY(30px); /* 初始位置向下偏移 */
        }
        
        .left-column, .right-column {
            width: 150%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 40px;
            opacity: 0; /* 初始状态为不可见 */
            transform: translateX(-30px); /* 初始位置向左偏移 */
        }
        
        .center-column {
            width: 50%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0; /* 初始状态为不可见 */
            transform: translateY(30px); /* 初始位置向下偏移 */
        }
        
        /* 信息图表样式 */
        .info-vis {
            height: fit-content;
            width: fit-content;
            min-width: 100%;
            opacity: 0; /* 初始状态为不可见 */
            transform: scale(0.9); /* 初始大小缩小 */
        }
        
        .vis-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #d4af37;
            text-align: center;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            padding-bottom: 10px;
            opacity: 0; /* 初始状态为不可见 */
        }
        
        /* 主视觉图片 */
        .main-visual {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 40px 0;
            opacity: 0; /* 初始状态为不可见 */
        }
        
        .instrument-img {
            width: 400px;
            height: 1000px;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.5));
            transition: all 0.3s ease;
            opacity: 0; /* 初始状态为不可见 */
            transform: scale(0.8) rotate(-5deg); /* 初始大小缩小且旋转 */
        }
        
        .instrument-img:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.5));
        }
        
        /* 五音特效 */
        .music-note {
            position: fixed;
            bottom: -50px;
            font-size: 2rem;
            opacity: 0.1;
            z-index: -1;
            font-family: "KingHwa_OldSong", serif;
            animation: floatUp 15s linear infinite;
        }
        
        @keyframes floatUp {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.1;
            }
            50% {
                opacity: 0.3;
            }
            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* 进入动画相关样式 */
        .fade-in {
            animation: fadeIn 1.5s ease forwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .slide-in-left {
            animation: slideInLeft 1.2s ease forwards;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .slide-in-right {
            animation: slideInRight 1.2s ease forwards;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .slide-in-up {
            animation: slideInUp 1.2s ease forwards;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .scale-in {
            animation: scaleIn 1.2s ease forwards;
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .rotate-in {
            animation: rotateIn 1.5s ease forwards;
        }
        
        @keyframes rotateIn {
            from {
                opacity: 0;
                transform: rotate(-15deg) scale(0.8);
            }
            to {
                opacity: 1;
                transform: rotate(0) scale(1);
            }
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .left-column, .right-column {
                width: 30%;
            }
            .center-column {
                width: 40%;
            }
        }
        
        @media (max-width: 900px) {
            .main-content {
                margin-left: 0;
                padding-left: 150px;
            }
            
            .timeline-nav {
                width: 100px;
            }
            
            .timeline-item {
                padding-left: 40px;
                font-size: 0.9rem;
            }
            
            .timeline-item::before {
                left: 26px;
            }
        }
        
        @media (max-width: 768px) {
            .page-section {
                flex-direction: column;
            }
            
            .left-column, .center-column, .right-column {
                width: 100%;
            }
            
            .main-visual {
                flex-direction: column;
            }
            
            .timeline-nav {
                display: none;
            }
            
            .main-content {
                padding-left: 20px;
                padding-right: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 标题 -->
    <div class="main-title">
        <span>织谱·天弦</span>
    </div>
    <svg id="sine-wave" width="14%" height="60" style="position: fixed; top: 4%; left: 1.4%; z-index: 9999;">
        <path id="sine-path" d="" fill="none" stroke="#e6c77d" stroke-width="1" stroke-opacity="0.5" />

    </svg>
    


    </svg>
    <script>
        // 定义正弦波动画函数
        function animateSineWave() {
            const svg = document.getElementById('sine-wave');
            const path = document.getElementById('sine-path');
            // 确保在 SVG 加载完成后获取正确的宽度和高度
            const width = svg.getBoundingClientRect().width;
            const height = svg.getBoundingClientRect().height;
            const amplitude = 10;
            const frequency = 0.02;
            const phase = 0;
            let time = 0;

            function updateWave() {
                const points = [];
                for (let x = 0; x <= width; x++) {
                    // 减小时间的增长系数，使动画变慢
                    const y = height / 2 + amplitude * Math.sin((x * frequency) + (time * 0.01)); 
                    points.push(`${x},${y}`);
                }
                path.setAttribute('d', `M${points.join('L')}`);
                time++;
                requestAnimationFrame(updateWave);
            }

            updateWave();
        }
        // 页面加载完成后启动动画
        window.addEventListener('load', animateSineWave);
    </script>
    
    <!-- 导航时间线 -->
    <div class="timeline-nav">
        <div class="timeline-line"></div>
        <div class="timeline-item active" data-section="history">弦歌<br>不辍</div>
        <div class="timeline-item" data-section="overview">弦乐<br>馔玉</div>
        <div class="timeline-item" data-section="comparison">丝律<br>之辨</div>
        <div class="timeline-item" data-section="masterpieces">千古<br>绝响</div>
        <div class="timeline-item" data-section="epilogue">弦音<br>永续</div>
    </div>
    
    <!-- 主内容区域 -->
    <div class="main-content">
        <!-- 历史发展部分 -->
        <section id="history" class="page-section">
            <div class="left-column">
                <div class="info-vis" id="history-timeline">
                    <h3 class="vis-title">中国弦乐发展</h3>
                    <div class="flourish-embed flourish-bar-chart-race" data-src="visualisation/23577812"><script src="https://public.flourish.studio/resources/embed.js"></script><noscript><img src="https://public.flourish.studio/visualisation/23577812/thumbnail" width="100%" alt="bar-chart-race visualization" /></noscript></div>
                    <svg width="100%" height="200"></svg>
                </div>
                
                <div class="info-vis" id="dynasty-distribution">
                    <h3 class="vis-title">中国弦乐器分类</h3>
                    <div class="flourish-embed flourish-hierarchy" data-src="visualisation/23568474" style="background-image: url('xiany01.svg'); background-size: cover; background-position: center;">
                        <script src="https://public.flourish.studio/resources/embed.js"></script>
                        <noscript><img src="https://public.flourish.studio/visualisation/23568474/thumbnail" width="100%" alt="hierarchy visualization" /></noscript>
                    </div>
                    <svg width="100%" height="1"></svg>
                </div>
                
                <div class="info-vis" id="initInstrumentOrigins">
                    <h3 class="vis-title">部分弦乐器传播路线</h3>
                    <svg width="100%" height="250"></svg>
                </div>
                

            </div>
            
            <div class="center-column" style="width: 200% !important;">
                <h2>弦歌不辍</h2>
                <p style="text-align: center;">中国弦乐器的历史可追溯至三千多年前的商周时期，是中国传统音乐文化的重要组成部分。<br><br> <br>点击中间的图形查看详细时间轴</p>
                
                <div class="main-visual">
<img src="static/img/pipa032.svg" alt="演奏" class="instrument-img" onclick="openTimelineModal()" style="transform: scale(1.2);">

<!-- 时间轴模态框 -->
<div id="linetimeModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2></h2>
        <div class="linetime-container">
            <div class="linetime-item">
                <div class="time">商周时期</div>
                <div class="content">出现最早的弦乐器雏形,以琴瑟为代表</div>
            </div>
            <div class="linetime-item">
                <div class="time">秦汉时期</div>
                <div class="content">琵琶传入,并逐渐本土化</div>
            </div>
            <div class="linetime-item">
                <div class="time">魏晋南北朝</div>
                <div class="content">箜篌、筝等乐器发展成熟</div>
            </div>
            <div class="linetime-item">
                <div class="time">隋唐时期</div>
                <div class="content">弦乐发展黄金时期,各类乐器齐放异彩</div>
            </div>
            <div class="linetime-item">
                <div class="time">宋元时期</div>
                <div class="content">民间音乐兴起,胡琴类乐器发展</div>
            </div>
            <div class="linetime-item">
                <div class="time">明清时期</div>
                <div class="content">戏曲音乐繁荣,京胡等新品种出现</div>
            </div>
        </div>
    </div>
</div>

<style>
/* 模态框样式 */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
}

.modal-content {
    position: relative;
    background: linear-gradient(to bottom, #1a0b4d, #4b0082);
    margin: 5% auto;
    padding: 20px;
    width: 80%;
    max-width: 800px;
    border: 2px solid #d4af37;
    border-radius: 10px;
    color: #d4af37;
    font-family: "KingHwa_OldSong", serif;
}

.close {
    position: absolute;
    right: 20px;
    top: 10px;
    font-size: 28px;
    cursor: pointer;
    color: #d4af37;
}

.close:hover {
    color: #ffe26e;
}

/* 时间轴样式 */
.linetime-container {
    margin-top: 30px;
    left: -20%;
    padding: 20px;
    position: relative;
}

.linetime-container::before {
    content: '';
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 2px;
    background: rgba(212, 175, 55, 0.5);
}

.linetime-item {
    margin: 30px 0;
    left: 21%;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

.linetime-item::before {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    background: #d4af37;
    border-radius: 50%;
    left: calc(30% - 6px);
    top: -20px;
}
.time {
    font-size: 1.2em;
    color: #ffe26e;
    margin-bottom: 10px;
}

.content {
    text-align: center;
    padding: 10px;
    background: rgba(212, 175, 55, 0.0);
    border-radius: 5px;
    left:    ;
}
</style>

<script>
// 模态框控制
function openTimelineModal() {
    document.getElementById("linetimeModal").style.display = "block";
}

// 点击关闭按钮关闭模态框
document.querySelector(".close").onclick = function() {
    document.getElementById("linetimeModal").style.display = "none";
}

// 点击模态框外部关闭模态框
window.onclick = function(event) {
    if (event.target == document.getElementById("linetimeModal")) {
        document.getElementById("linetimeModal").style.display = "none";
    }
}
</script>
                </div>
                
                <div class="history-content">
                    <p style="font-family: 'KingHwa_OldSong', serif; font-size: 0.9em;">早在《诗经》中就有"琴瑟友之"的记载，周代已有琴、瑟等弦乐器。汉代张骞通西域后，琵琶类乐器传入中原，经本土化改造形成中国特色的琵琶。唐宋时期，弦乐器发展达到高峰，不仅种类增多，演奏技法也日趋成熟。</p>
                    <p style="font-family: 'KingHwa_OldSong', serif; font-size: 0.9em;">明清时期，随着戏曲艺术的繁荣，二胡、京胡等拉弦乐器得到广泛应用。近代以来，传统弦乐器在保持原有特色的基础上不断革新，既传承了古典韵味，又适应了现代音乐表现的需要。</p>
                </div>
            </div>
            
            <div class="right-column">
                <div class="info-vis" id="instrument-origins">
                    <h3 class="vis-title">中国弦乐器起源与地区发展</h3>
                    <div class="flourish-embed flourish-map" data-src="visualisation/23568531"><script src="https://public.flourish.studio/resources/embed.js"></script><noscript><img src="https://public.flourish.studio/visualisation/23568531/thumbnail" width="100%" alt="map visualization" /></noscript></div>
                    <svg width="100%" height="0"></svg>
                </div>
                
                <div class="info-vis" id="dynasty-comparison">
                    <h3 class="vis-title">朝代间弦乐交流</h3>
                    <svg width="100%" height="250"></svg>
                </div>
                
<div class="info-vis" id="lishifazhan">
    <h3 class="vis-title">中国弦乐器历史发展关系图</h3>
    <svg width="100%" height="300"></svg>
    <div style="text-align: center; font-size: 12px; color: #d4af37; margin-top: 5px;">拖拽来查看数据</div>
</div>

<script>
// 历史发展关系图数据
const historyData = {
    nodes: [
        { id: "古琴", group: 1, year: "前2000", link: "guqin.html" },
        { id: "瑟", group: 1, year: "前1500", link: "se.html" },
        { id: "琵琶", group: 2, year: "前200", link: "pipa.html" },
        { id: "阮", group: 2, year: "200", link: "ruan.html" },
        { id: "箜篌", group: 3, year: "300", link: "konghou.html" },
        { id: "筝", group: 3, year: "400", link: "zheng.html" },
        { id: "二胡", group: 4, year: "900", link: "erhu.html" },
        { id: "胡琴", group: 4, year: "600", link: "huqin.html" },
        { id: "月琴", group: 2, year: "800", link: "yueqin.html" },
        { id: "三弦", group: 2, year: "1000", link: "sanxian.html" },
        { id: "扬琴", group: 3, year: "1100", link: "yangqin.html" },
        { id: "京胡", group: 4, year: "1800", link: "jinghu.html" },
        { id: "板胡", group: 4, year: "1600", link: "banhu.html" },
        { id: "高胡", group: 4, year: "1900", link: "gaohu.html" },
        { id: "中胡", group: 4, year: "1950", link: "zhonghu.html" }
    ],
    links: [
        { source: "古琴", target: "瑟", value: 5, period: "先秦" },
        { source: "琵琶", target: "阮", value: 3, period: "汉代" },
        { source: "箜篌", target: "筝", value: 4, period: "魏晋" },
        { source: "胡琴", target: "二胡", value: 4, period: "唐代" },
        { source: "古琴", target: "琵琶", value: 2, period: "隋唐" },
        { source: "瑟", target: "筝", value: 3, period: "宋代" },
        { source: "琵琶", target: "月琴", value: 3, period: "唐代" },
        { source: "月琴", target: "三弦", value: 2, period: "宋代" },
        { source: "胡琴", target: "京胡", value: 3, period: "清代" },
        { source: "胡琴", target: "板胡", value: 3, period: "明代" },
        { source: "二胡", target: "高胡", value: 2, period: "民国" },
        { source: "二胡", target: "中胡", value: 2, period: "现代" },
        { source: "筝", target: "扬琴", value: 3, period: "宋代" },
        // 添加二胡和琵琶的连接
        { source: "琵琶", target: "二胡", value: 4, period: "唐代" }
    ]
};

// 初始化力导向图
function initHistoryGraph() {
    const svg = d3.select("#lishifazhan svg");
    const width = svg.node().getBoundingClientRect().width;
    const height = svg.node().getBoundingClientRect().height;

    // 创建力导向模拟
    const simulation = d3.forceSimulation(historyData.nodes)
        .force("link", d3.forceLink(historyData.links).id(d => d.id))
        .force("charge", d3.forceManyBody().strength(-100))
        .force("center", d3.forceCenter(width / 2, height / 2));

    // 绘制连线
    const link = svg.append("g")
        .selectAll("line")
        .data(historyData.links)
        .enter().append("line")
        .attr("stroke", "#d4af37")
        .attr("stroke-opacity", 0.6)
        .attr("stroke-width", d => Math.sqrt(d.value));

    // 绘制节点
    const node = svg.append("g")
        .selectAll("circle")
        .data(historyData.nodes)
        .enter().append("circle")
        .attr("r", 8)
        .attr("fill", d => d3.schemeCategory10[d.group-1])
        .call(drag(simulation));

    // 添加文字标签
    const text = svg.append("g")
        .selectAll("text")
        .data(historyData.nodes)
        .enter().append("text")
        .text(d => d.id)
        .attr("font-size", "12px")
        .attr("dx", 12)
        .attr("dy", 4)
        .style("fill", "#d4af37");

    // 更新位置
    simulation.on("tick", () => {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);

        text
            .attr("x", d => d.x)
            .attr("y", d => d.y);
    });

    // 拖拽功能
    function drag(simulation) {
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }
        
        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }
        
        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
        
        return d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
    }
}

// 页面加载完成后初始化图表
document.addEventListener('DOMContentLoaded', initHistoryGraph);
</script>
                
                

                

            </div>
        </section>
        
        <!-- 弦乐概览部分 -->
        <section id="overview" class="page-section">
            <div class="left-column">
<div class="info-vis" id="instfam">
    <h3 class="vis-title">中国弦乐器家族分类</h3>
    <svg width="100%" height="350"></svg>
</div>

<script>
// 弦乐器家族分类数据
const familyData = {
    name: "中国弦乐器",
    children: [
        {
            name: "弹拨乐器",
            children: [
                {name: "琵琶", value: 30},
                {name: "古琴", value: 25}, 
                {name: "古筝", value: 28},
                {name: "阮", value: 15}
            ]
        },
        {
            name: "拉弦乐器", 
            children: [
                {name: "二胡", value: 35},
                {name: "板胡", value: 20},
                {name: "京胡", value: 18},
                {name: "高胡", value: 15}
            ]
        },
        {
            name: "击弦乐器",
            children: [
                {name: "扬琴", value: 25},
                {name: "古筝击弦", value: 15}
            ]
        }
    ]
};

// 初始化树形图
function initFamilyTree() {
    const svg = d3.select("#instfam svg");
    const width = svg.node().getBoundingClientRect().width * 1; // 缩小宽度到80%
    const height = svg.node().getBoundingClientRect().height * 1; // 缩小高度到80%
    const margin = {top: 15, right: 15, bottom: 15, left: 15}; // 缩小边距
    // 创建分层布局
    const root = d3.hierarchy(familyData)
        .sum(d => d.value ? d.value : 0);
        
    // 使用树形图布局
    const treeLayout = d3.tree()
        .size([height - margin.top - margin.bottom, width - margin.left - margin.right]);
    
    treeLayout(root);
    
    // 创建连接线生成器
    const linkGenerator = d3.linkHorizontal()
        .x(d => d.y)
        .y(d => d.x);
    
    // 添加渐变效果
    const gradient = svg.append("defs")
        .append("linearGradient")
        .attr("id", "linkGradient")
        .attr("gradientUnits", "userSpaceOnUse");
    
    gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", "#d4af37")
        .attr("stop-opacity", 0.8);
    
    gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", "#ffe26e")
        .attr("stop-opacity", 0.4);
    
    // 绘制连接线
    svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`)
        .selectAll("path")
        .data(root.links())
        .join("path")
        .attr("d", linkGenerator)
        .attr("fill", "none")
        .attr("stroke", "url(#linkGradient)")
        .attr("stroke-width", 2)
        .attr("stroke-linecap", "round");
    
    // 绘制节点组
    const nodes = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`)
        .selectAll("g")
        .data(root.descendants())
        .join("g")
        .attr("transform", d => `translate(${d.y},${d.x})`);
    
    // 添加节点装饰圆环
    nodes.append("circle")
        .attr("r", d => d.data.value ? 8 : 5)
        .attr("fill", "#1a0b4d")
        .attr("stroke", "#d4af37")
        .attr("stroke-width", 2)
        .attr("filter", "url(#glow)");
    
    // 添加文字标签
    nodes.append("text")
        .attr("dy", "0.31em")
        .attr("x", d => d.children ? -12 : 12)
        .attr("text-anchor", d => d.children ? "end" : "start")
        .attr("font-family", "KingHwa_OldSong, serif")
        .text(d => d.data.name)
        .attr("fill", "#d4af37")
        .attr("font-size", d => d.depth === 0 ? "16px" : "14px")
        .attr("filter", "url(#glow)");
}

// 页面加载完成后初始化图表
window.addEventListener('load', initFamilyTree);
</script>
                
<div class="info-vis" id="regdistribution">
    <h3 class="vis-title">地域分布特征</h3>
    <svg width="100%" height="300"></svg>
</div>

<script>
// 初始化地域分布图
function initRegionalDistribution() {
    const width = document.querySelector("#regdistribution svg").clientWidth;
    const height = 300;
    const margin = {top: 20, right: 20, bottom: 30, left: 40};

    const svg = d3.select("#regdistribution svg");

    // 地域分布数据
    const data = [
        {region: "华北", value: 85, instruments: ["古琴","琵琶","二胡"]},
        {region: "华东", value: 92, instruments: ["二胡","琵琶","扬琴"]},
        {region: "华南", value: 78, instruments: ["高胡","阮","筝"]},
        {region: "西北", value: 65, instruments: ["四胡","三弦"]},
        {region: "西南", value: 71, instruments: ["月琴","板胡"]},
        {region: "东北", value: 68, instruments: ["京胡","板胡"]}
    ];

    // 创建比例尺
    const x = d3.scaleBand()
        .domain(data.map(d => d.region))
        .range([margin.left, width - margin.right])
        .padding(0.3);

    const y = d3.scaleLinear()
        .domain([0, 100])
        .range([height - margin.bottom, margin.top]);

    // 添加渐变
    const gradient = svg.append("defs")
        .append("linearGradient")
        .attr("id", "bar-gradient")
        .attr("x1", "0%")
        .attr("y1", "0%")
        .attr("x2", "0%")
        .attr("y2", "100%");

    gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", "#d4af37");

    gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", "#8b4513");

    // 绘制柱状图
    const bars = svg.selectAll("rect")
        .data(data)
        .join("rect")
        .attr("x", d => x(d.region))
        .attr("y", height - margin.bottom)
        .attr("width", x.bandwidth())
        .attr("height", 0)
        .attr("fill", "url(#bar-gradient)")
        .attr("rx", 5)
        .attr("ry", 5);

    // 添加动画
    bars.transition()
        .duration(1000)
        .delay((d, i) => i * 100)
        .attr("y", d => y(d.value))
        .attr("height", d => height - margin.bottom - y(d.value));

    // 添加坐标轴
    svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x))
        .selectAll("text")
        .attr("fill", "#d4af37")
        .style("font-size", "12px");

    svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y))
        .selectAll("text")
        .attr("fill", "#d4af37")
        .style("font-size", "12px");

    // 添加交互提示
    const tooltip = d3.select("#regdistribution")
        .append("div")
        .attr("class", "tooltip")
        .style("position", "absolute")
        .style("visibility", "hidden")
        .style("background", "rgba(0,0,0,0.8)")
        .style("color", "#d4af37")
        .style("padding", "10px")
        .style("border-radius", "5px")
        .style("font-size", "12px");

    bars.on("mouseover", function(event, d) {
        d3.select(this)
            .transition()
            .duration(200)
            .attr("fill", "#ffe26e");
            
        tooltip.html(`
            <strong>${d.region}</strong><br>
            普及度: ${d.value}%<br>
            代表乐器: ${d.instruments.join(", ")}
        `)
        .style("visibility", "visible")
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 10) + "px");
    })
    .on("mouseout", function() {
        d3.select(this)
            .transition()
            .duration(200)
            .attr("fill", "url(#bar-gradient)");
            
        tooltip.style("visibility", "hidden");
    });

    // 添加标题
    svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top)
        .attr("text-anchor", "middle")
        .attr("fill", "#d4af37")
        .style("font-size", "14px")
        .text("中国各地区传统弦乐普及度");
}

// 页面加载完成后初始化图表
document.addEventListener("DOMContentLoaded", initRegionalDistribution);
</script>
<div class="info-vis" id="sound-characteristics">
    <h3 class="vis-title">音色特征雷达图</h3>
    <svg width="100%" height="400"></svg>
</div>

<script>
// 音色特征雷达图数据
const soundData = {
    characteristics: ["明亮度", "温暖度", "清澈度", "厚重感", "穿透力"],
    instruments: [
        {
            name: "弹拨",
            values: [0.9, 0.6, 0.8, 0.5, 0.85]
        },
        {
            name: "拉弦", 
            values: [0.7, 0.85, 0.75, 0.6, 0.9]
        },
    ]
};

// 初始化雷达图
function initRadarChart() {
    const svg = d3.select("#sound-characteristics svg");
    const width = svg.node().getBoundingClientRect().width;
    const height = svg.node().getBoundingClientRect().height;
    const radius = Math.min(width, height) / 2 - 40;
    
    // 创建比例尺和角度计算
    const angleScale = d3.scaleLinear()
        .domain([0, soundData.characteristics.length])
        .range([0, 2 * Math.PI]);
        
    const radiusScale = d3.scaleLinear()
        .domain([0, 1])
        .range([0, radius]);
    
    // 创建雷达图路径生成器
    const radarLine = d3.lineRadial()
        .radius(d => radiusScale(d))
        .angle((d, i) => angleScale(i));
    
    // 添加图形组并移动到中心
    const g = svg.append("g")
        .attr("transform", `translate(${width/2},${height/2})`);
    
    // 绘制背景网格
    const levels = [0.2, 0.4, 0.6, 0.8, 1];
    levels.forEach(level => {
        g.append("path")
            .datum(new Array(soundData.characteristics.length + 1).fill(level))
            .attr("d", radarLine)
            .attr("fill", "none")
            .attr("stroke", "#d4af37")
            .attr("stroke-width", 0.5)
            .attr("opacity", 0.3);
    });
    
    // 绘制轴线
    soundData.characteristics.forEach((char, i) => {
        const angle = angleScale(i);
        const x = radius * Math.cos(angle - Math.PI/2);
        const y = radius * Math.sin(angle - Math.PI/2);
        
        g.append("line")
            .attr("x1", 0)
            .attr("y1", 0)
            .attr("x2", x)
            .attr("y2", y)
            .attr("stroke", "#d4af37")
            .attr("stroke-width", 0.5)
            .attr("opacity", 0.3);
            
        // 添加特征标签
        g.append("text")
            .attr("x", x * 1.1)
            .attr("y", y * 1.1)
            .attr("text-anchor", "middle")
            .attr("fill", "#d4af37")
            .attr("font-size", "12px")
            .text(char);
    });
    
    // 绘制数据路径
    soundData.instruments.forEach((instrument, idx) => {
        const color = idx === 0 ? "#ff6b6b" : "#4ecdc4";
        
        // 绘制填充区域
        g.append("path")
            .datum(instrument.values.concat(instrument.values[0]))
            .attr("d", radarLine)
            .attr("fill", color)
            .attr("fill-opacity", 0.2)
            .attr("stroke", color)
            .attr("stroke-width", 2);
            
        // 添加数据点
        instrument.values.forEach((value, i) => {
            const angle = angleScale(i) - Math.PI/2;
            const r = radiusScale(value);
            
            g.append("circle")
                .attr("cx", r * Math.cos(angle))
                .attr("cy", r * Math.sin(angle))
                .attr("r", 4)
                .attr("fill", color);
        });
    });
    
    // 添加图例
    const legend = svg.append("g")
        .attr("transform", `translate(${width-100},20)`);
        
    soundData.instruments.forEach((instrument, idx) => {
        const color = idx === 0 ? "#ff6b6b" : "#4ecdc4";
        
        legend.append("rect")
            .attr("x", 0)
            .attr("y", idx * 20)
            .attr("width", 15)
            .attr("height", 15)
            .attr("fill", color);
            
        legend.append("text")
            .attr("x", 20)
            .attr("y", idx * 20 + 12)
            .attr("fill", "#d4af37")
            .attr("font-size", "12px")
            .text(instrument.name);
    });
}

// 页面加载完成后初始化图表
window.addEventListener('load', initRadarChart);
</script>
            </div>
            
            <div class="center-column">
                <h2>弦乐馔玉</h2>
                <p>中国传统弦乐器种类繁多，按演奏方式可分为弹拨、拉弦和击弦三大类，各具特色又相互影响。</p>
                
                <div class="main-visual">
                    <img src="static/img/pipa021.svg" alt="乐器" class="instrument-img" style="transform: scale(1.1);">
                </div>
                
                <div class="overview-content">
                    <p style="font-family: 'KingHwa_OldSong', serif; font-size: 0.9rem;">弹拨类以琵琶、古筝、古琴为代表，音色清脆明亮，技法丰富多变。拉弦类以二胡、高胡、中胡为代表，音色柔美悠扬，表现力极强。击弦类以扬琴为代表，兼具旋律与和声功能。</p>
                </div>
            </div>
            
            <div class="right-column">
<div class="info-vis" id="repanalysis">
    <h3 class="vis-title" style="font-family: 'KingHwa_OldSong', serif; font-size: 1.5em;">曲目类型分布</h3>
    <svg width="100%" height="300"></svg>
    <div class="chart-tooltip" style="position: absolute; display: none; background: rgba(0,0,0,0.8); color: #fff; padding: 8px; border-radius: 4px;"></div>
</div>

<script>
// 初始化曲目分析图表
function initRepertoireAnalysis() {
    const data = [
        { type: "古典文献", value: 35, color: "#8B4513" }, // 深棕色
        { type: "民间乐曲", value: 25, color: "#DAA520" }, // 金黄色
        { type: "戏曲音乐", value: 20, color: "#CD853F" }, // 秋褐色
        { type: "现代创作", value: 15, color: "#D2691E" }, // 巧克力色
        { type: "跨界作品", value: 5, color: "#BC8F8F" }  // 玫瑰褐色
    ];

    const svg = d3.select("#repanalysis svg");
    const width = svg.node().getBoundingClientRect().width;
    const height = svg.node().getBoundingClientRect().height;
    const radius = Math.min(width, height) / 2;
    
    const arc = d3.arc()
        .innerRadius(radius * 0.4)
        .outerRadius(radius * 0.8);
    
    const pie = d3.pie()
        .value(d => d.value)
        .sort(null);
    
    const g = svg.append("g")
        .attr("transform", `translate(${width/2},${height/2})`);
    
    // 添加渐变效果
    const gradient = svg.append("defs").selectAll("radialGradient")
        .data(data)
        .enter().append("radialGradient")
        .attr("id", (d,i) => `gradient-${i}`)
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("cx", "0")
        .attr("cy", "0")
        .attr("r", radius);
        
    gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", d => d3.rgb(d.color).brighter(0.5));
        
    gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", d => d.color);

    // 绘制扇形
    const path = g.selectAll("path")
        .data(pie(data))
        .enter().append("path")
        .attr("d", arc)
        .attr("fill", (d,i) => `url(#gradient-${i})`)
        .attr("stroke", "#fff")
        .attr("stroke-width", 2)
        .style("cursor", "pointer")
        .on("mouseover", function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr("transform", function(d) {
                    const centroid = arc.centroid(d);
                    return `translate(${centroid[0] * 0.1},${centroid[1] * 0.1})`;
                });
                
            const tooltip = d3.select(".chart-tooltip");
            tooltip.style("display", "block")
                .html(`${d.data.type}: ${d.data.value}%`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        })
        .on("mouseout", function() {
            d3.select(this)
                .transition()
                .duration(200)
                .attr("transform", "translate(0,0)");
                
            d3.select(".chart-tooltip").style("display", "none");
        });

    // 添加文本标签
    const text = g.selectAll("text")
        .data(pie(data))
        .enter().append("text")
        .attr("transform", d => `translate(${arc.centroid(d)})`)
        .attr("dy", ".35em")
        .style("text-anchor", "middle")
        .style("font-size", "15px") // 增大字体大小
        .style("font-family", "'KingHwa_OldSong', serif") // 使用标题字体
        .style("fill", "#fff") // 使用金色
        .text(d => d.data.type);

    // 添加动画效果
    path.transition()
        .duration(1000)
        .attrTween("d", function(d) {
            const interpolate = d3.interpolate({startAngle: 0, endAngle: 0}, d);
            return function(t) {
                return arc(interpolate(t));
            };
        });
}

// 页面加载完成后初始化图表
document.addEventListener("DOMContentLoaded", initRepertoireAnalysis);
</script>
                
<div class="info-vis" id="cultural-significance">
    <h3 class="vis-title" style="font-family: 'KingHwa_OldSong', serif; font-size: 1.5em;">文化意义权重</h3>
    <svg width="100%" height="250"></svg>
    <div style="text-align: center; font-size: 12px; color: #d4af37; margin-top: 5px;">拖拽节点查看详细信息</div>
</div>

<script>
// 创建力导向图展示文化意义权重关系
const culturalData = {
    nodes: [
        {id: "音乐价值", value: 120, group: 1, color: "#C19875"}, // 唐三彩褐色
        {id: "历史传承", value: 150, group: 1, color: "#8B634B"}, // 唐三彩深褐色
        {id: "文学艺术", value: 85, group: 2, color: "#F3D598"}, // 唐三彩黄色
        {id: "民俗文化", value: 95, group: 2, color: "#E6B422"}, // 唐三彩金黄色
        {id: "教育意义", value: 65, group: 3, color: "#7FB80E"}, // 唐三彩绿色
        {id: "社会影响", value: 110, group: 3, color: "#1B813E"}, // 唐三彩深绿色
        {id: "精神象征", value: 160, group: 4, color: "#2EA9DF"}, // 唐三彩蓝色
        {id: "美学价值", value: 130, group: 4, color: "#1B5AA5"} // 唐三彩深蓝色
    ],
    links: [
        {source: "音乐价值", target: "历史传承", strength: 0.7},
        {source: "历史传承", target: "文学艺术", strength: 0.6},
        {source: "文学艺术", target: "民俗文化", strength: 0.8},
        {source: "民俗文化", target: "教育意义", strength: 0.5},
        {source: "教育意义", target: "社会影响", strength: 0.7},
        {source: "社会影响", target: "精神象征", strength: 0.9},
        {source: "精神象征", target: "美学价值", strength: 0.8},
        {source: "美学价值", target: "音乐价值", strength: 0.7}
    ]
};

// 初始化力导向图
const svg = d3.select("#cultural-significance svg");
const width = svg.node().getBoundingClientRect().width;
const height = svg.node().getBoundingClientRect().height;

// 创建力导向模拟
const simulation = d3.forceSimulation(culturalData.nodes)
    .force("link", d3.forceLink(culturalData.links)
        .id(d => d.id)
        .distance(d => (1 - d.strength) * 100))
    .force("charge", d3.forceManyBody().strength(-200))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("collision", d3.forceCollide().radius(30));

// 定义渐变色
const gradient = svg.append("defs")
    .selectAll("linearGradient")
    .data(culturalData.links)
    .enter()
    .append("linearGradient")
    .attr("id", (d,i) => `gradient-${i}`)
    .attr("gradientUnits", "userSpaceOnUse");

gradient.append("stop")
    .attr("offset", "0%")
    .attr("stop-color", "#d4af37");

gradient.append("stop")
    .attr("offset", "100%")
    .attr("stop-color", "#ff6b6b");

// 绘制连线
const link = svg.append("g")
    .selectAll("line")
    .data(culturalData.links)
    .enter()
    .append("line")
    .attr("stroke", (d,i) => `url(#gradient-${i})`)
    .attr("stroke-width", d => d.strength * 0.1)
    .attr("stroke-opacity", 0.6);

// 创建节点组
const node = svg.append("g")
    .selectAll("g")
    .data(culturalData.nodes)
    .enter()
    .append("g")
    .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended));

// 添加节点圆圈
node.append("circle")
    .attr("r", d => d.value / 8)
    .attr("fill", d => d3.schemeCategory10[d.group-1])
    .attr("stroke", "#fff")
    .attr("stroke-width", 2);

// 添加文字标签
node.append("text")
    .text(d => d.id)
    .attr("font-family", "'KingHwa_OldSong', serif")
    .attr("font-size", "12px")
    .attr("dx", 15)
    .attr("dy", 4)
    .style("fill", "#d4af37");

// 添加动画效果
simulation.on("tick", () => {
    link
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);

    node
        .attr("transform", d => `translate(${d.x},${d.y})`);
});

// 拖拽相关函数
function dragstarted(event) {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    event.subject.fx = event.subject.x;
    event.subject.fy = event.subject.y;
}

function dragged(event) {
    event.subject.fx = event.x;
    event.subject.fy = event.y;
}

function dragended(event) {
    if (!event.active) simulation.alphaTarget(0);
    event.subject.fx = null;
    event.subject.fy = null;
}

// 添加悬停效果
node.on("mouseover", function(event, d) {
    d3.select(this).select("circle")
        .transition()
        .duration(300)
        .attr("r", d => d.value / 6);
})
.on("mouseout", function(event, d) {
    d3.select(this).select("circle")
        .transition()
        .duration(300)
        .attr("r", d => d.value / 8);
});
</script>
                
<div class="info-vis" id="craftsmanship">
    <h3 class="vis-title" style="font-family: 'KingHwa_OldSong', serif; font-size: 1.8rem; text-align: center; margin-bottom: 20px; color: #d4af37; text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);">
        乐器制作工艺
    </h3>
    <svg width="100%" height="500" class="craftsmanship-svg"></svg>
    <div class="tooltip" style="position: absolute; display: none; background: rgba(26, 11, 77, 0.9); border: 1px solid #d4af37; padding: 10px; border-radius: 5px;"></div>
</div>

<script>
// 制作工艺数据
const craftData = {
    "选材": {
        "木材": ["桐木", "梧桐", "红木"],
        "弦材": ["钢丝", "尼龙", "丝弦"],
        "装饰": ["贝壳", "玉石", "象牙"]
    },
    "工序": {
        "制身": ["开料", "打磨", "抛光"],
        "装弦": ["定位", "固定", "调音"],
        "装饰": ["镶嵌", "彩绘", "雕刻"]
    }
};

// 初始化交互式工艺图
function initCraftsmanshipVis() {
    const svg = d3.select("#craftsmanship .craftsmanship-svg");
    const width = svg.node().getBoundingClientRect().width;
    const height = svg.node().getBoundingClientRect().height;
    const tooltip = d3.select("#craftsmanship .tooltip");
    
    // 创建力导向图布局
    const simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(d => d.id).distance(50)) // 增加连接距离
        .force("charge", d3.forceManyBody().strength(50)) // 增加排斥力
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide().radius(30)) // 添加碰撞力
        .force("x", d3.forceX(width / 2).strength(0.1)) // 添加x方向力
        .force("y", d3.forceY(height / 2).strength(0.1)); // 添加y方向力

    // 转换数据格式
    const nodes = [];
    const links = [];
    
    Object.entries(craftData).forEach(([category, items]) => {
        nodes.push({id: category, group: 1, weight: 10}); // 添加权重
        Object.entries(items).forEach(([step, details]) => {
            nodes.push({id: step, group: 2, weight: 5});
            links.push({source: category, target: step, value: 3}); // 添加连接强度
            details.forEach(detail => {
                nodes.push({id: detail, group: 3, weight: 2});
                links.push({source: step, target: detail, value: 2});
            });
        });
    });

    // 绘制连接线
    const link = svg.append("g")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("stroke", "#d4af37")
        .attr("stroke-opacity", 0.6)
        .attr("stroke-width", d => Math.sqrt(d.value) * 1); // 根据连接强度设置线宽

    // 绘制节点
    const node = svg.append("g")
        .selectAll("circle")
        .data(nodes)
        .enter().append("circle")
        .attr("r", d => d.weight * 2) // 根据权重设置半径
        .attr("fill", d => d.group === 1 ? "#ff6b6b" : d.group === 2 ? "#d4af37" : "#4b0082")
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));

    // 添加文字标签
    const text = svg.append("g")
        .selectAll("text")
        .data(nodes)
        .enter().append("text")
        .text(d => d.id)
        .attr("font-family", "'KingHwa_OldSong', serif")
        .attr("font-size", d => d.group === 1 ? "16px" : "12px") // 增大主要节点文字
        .attr("fill", "#d4af37")
        .attr("dx", d => d.weight * 2 + 5) // 根据节点大小调整文字位置
        .attr("dy", 4);

    // 添加交互效果
    node.on("mouseover", function(event, d) {
            // 高亮相关连接
            link.style("stroke", l => (l.source === d || l.target === d) ? "#ff6b6b" : "#d4af37")
                .style("stroke-opacity", l => (l.source === d || l.target === d) ? 1 : 0.2);
            
            tooltip.style("display", "block")
                .html(`${d.id}<br>${d.group === 1 ? '工艺类别' : d.group === 2 ? '工序步骤' : '具体细节'}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
            
            // 放大当前节点
            d3.select(this)
                .transition()
                .duration(200)
                .attr("r", d.weight * 2.5);
        })
        .on("mouseout", function(event, d) {
            link.style("stroke", "#d4af37")
                .style("stroke-opacity", 0.6);
            
            tooltip.style("display", "none");
            
            // 恢复节点大小
            d3.select(this)
                .transition()
                .duration(200)
                .attr("r", d.weight * 2);
        });

    // 更新布局
    simulation
        .nodes(nodes)
        .on("tick", ticked);

    simulation.force("link")
        .links(links);

    // 定义拖拽行为
    function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }

    function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }

    function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }

    // 更新位置
    function ticked() {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);

        text
            .attr("x", d => d.x)
            .attr("y", d => d.y);
    }
}

// 页面加载完成后初始化图表
window.addEventListener('load', initCraftsmanshipVis);
</script>
                
                </div>
          </section>
           <section id="comparison" class="page-section">
            <div class="left-column">
                <div class="info-vis" id="pipa-structure">
                    <h3 class="vis-title">琵琶构造解析</h3>
                    <img src="static/img/pipacg1.svg" alt="琵琶" style="width: 100%; height: 350px; object-fit: contain;">
                </div>
                
                <div class="info-vis" id="erhu-structure">
                    <h3 class="vis-title">二胡构造解析</h3>
                    <img src="static/img/erhucg1.svg" alt="琵琶" style="width: 100%; height: 350px; object-fit: contain;">
                </div>
            </div>
            
            <div class="center-column"style="width: 200% !important;">
                <h2>丝律之辨</h2>
                <p>琵琶与二胡作为中国传统弦乐器的两大代表，各具特色又相互补充，共同构成了中国器乐艺术的重要支柱。 <br> <br> <br></p>
                
                <div class="main-visual">
                    <div class="flourish-embed flourish-sankey" data-src="visualisation/23570980" style="transform: scale(1); transform-origin: top left; height: 600px; width: 600px;"><script src="https://public.flourish.studio/resources/embed.js"></script><noscript><img src="https://public.flourish.studio/visualisation/23570980/thumbnail" width="200px" height="500px" alt="sankey visualization" style="transform: scale(1);" /></noscript></div>                </div>
                
                <div class="comparison-content">
                    <p style="font-family: 'KingHwa_OldSong', serif; font-size: 0.9rem;">琵琶是弹拨乐器的代表，有四根弦、二十四个品，音域宽广，技法丰富，既能表现金戈铁马的雄壮，又能演绎小桥流水的婉约。二胡是拉弦乐器的代表，仅两根弦却能奏出极富表现力的音色，擅长模仿人声，表达细腻情感。</p>
                    <p style="font-family: 'KingHwa_OldSong', serif; font-size: 0.9rem;">在传统合奏中，琵琶常担任旋律和节奏的主导，二胡则负责情感的渲染。两者配合，刚柔相济，形成独特的音响效果。现代演奏中，两种乐器都突破了传统局限，发展出更多创新技法，拓展了表现空间。</p>
                </div>
            </div>
            
            <div class="right-column">
                <div class="info-vis" id="playingtec">
                    <h3 class="vis-title">演奏技法对比</h3>
                    <svg id="technique-comparison" width="100%" height="250"></svg>
                </div>
                <script>
                    // 演奏技法对比图表数据
                    const techniqueData = [
                        { instrument: '琵琶', technique: '轮指', score: 8 },
                        { instrument: '琵琶', technique: '扫弦', score: 7 },
                        { instrument: '琵琶', technique: '弹挑', score: 7.5 },
                        { instrument: '二胡', technique: '揉弦', score: 9 },
                        { instrument: '二胡', technique: '抛弓', score: 7 },
                        { instrument: '二胡', technique: '连弓', score: 7.8 },
                        { instrument: '古琴', technique: '打圆', score: 8 },
                        { instrument: '古琴', technique: '撮音', score: 7 },
                        { instrument: '古琴', technique: '吟猱', score: 8.8 },
                    ];

                    // 初始化演奏技法对比图表
                    function initTechniqueComparisonChart() {
                        const svg = d3.select("#technique-comparison");
                        const width = svg.node().getBoundingClientRect().width;
                        const height = 250;
                        const margin = { top: 20, right: 20, bottom: 30, left: 40 };
                        const innerWidth = width - margin.left - margin.right;
                        const innerHeight = height - margin.top - margin.bottom;

                        const g = svg.append("g")
                            .attr("transform", `translate(${margin.left},${margin.top})`);

                        // 定义 x 比例尺
                        const xScale = d3.scaleBand()
                            .domain(techniqueData.map(d => d.technique))
                            .range([0, innerWidth])
                            .padding(0.1);

                        // 定义 y 比例尺
                        const yScale = d3.scaleLinear()
                            .domain([0, d3.max(techniqueData, d => d.score)])
                            .range([innerHeight, 0]);

                        // 添加 x 轴
                        g.append("g")
                            .attr("transform", `translate(0,${innerHeight})`)
                            .call(d3.axisBottom(xScale));

                        // 添加 y 轴
                        g.append("g")
                            .call(d3.axisLeft(yScale));

                        // 添加柱状图
                        g.selectAll(".bar")
                            .data(techniqueData)
                            .enter().append("rect")
                            .attr("class", "bar")
                            .attr("x", d => xScale(d.technique))
                            .attr("y", d => yScale(d.score))
                            .attr("width", xScale.bandwidth())
                            .attr("height", d => innerHeight - yScale(d.score))
                            .attr("fill", d => {
                                if (d.instrument === '琵琶') return '#FF6B6B';
                                if (d.instrument === '二胡') return '#4ECDC4';
                                if (d.instrument === '古琴') return '#1A535C';
                            });

                        // 添加图例
                        const legend = g.append("g")
                            // 修改字体为标题字体
                            .attr("font-family", "KingHwa_OldSong, serif") 
                            .attr("font-size", 10)
                            .attr("text-anchor", "end")
                            .attr("fill", "white") // 将字体颜色改为白色
                            .selectAll("g")
                            .data(['琵琶', '二胡', '古琴'])
                            .enter().append("g")
                            .attr("transform", (d, i) => `translate(0,${i * 20})`);

                        legend.append("rect")
                            .attr("x", innerWidth - 19)
                            .attr("width", 19)
                            .attr("height", 19)
                            .attr("fill", d => {
                                if (d === '琵琶') return '#FF6B6B';
                                if (d === '二胡') return '#4ECDC4';
                                if (d === '古琴') return '#1A535C';
                            });

                        legend.append("text")
                            .attr("x", innerWidth - 24)
                            .attr("y", 9.5)
                            .attr("dy", "0.32em")
                            .text(d => d);
                    }

                    // 页面加载完成后初始化图表
                    window.addEventListener('load', initTechniqueComparisonChart);
                </script>
                
                <div class="info-vis" id="sound-spectrum">
                    <h3 class="vis-title">频谱特征比较</h3>
                    <svg width="100%" height="250"></svg>
                    <div class="chart-tooltip" style="position: absolute; display: none; background: rgba(0,0,0,0.8); color: #fff; padding: 8px; border-radius: 4px;"></div>
                </div>
                <script>
                    // 初始化频谱特征比较图表
                    function initSoundSpectrum() {
                        // 模拟频谱数据
                        const data = [
                            { frequency: "20Hz", amplitude: 0.2, instrument: "琵琶" },
                            { frequency: "100Hz", amplitude: 0.5, instrument: "琵琶" },
                            { frequency: "500Hz", amplitude: 0.8, instrument: "琵琶" },
                            { frequency: "1000Hz", amplitude: 0.6, instrument: "琵琶" },
                            { frequency: "5000Hz", amplitude: 0.4, instrument: "琵琶" },
                            { frequency: "20Hz", amplitude: 0.3, instrument: "二胡" },
                            { frequency: "100Hz", amplitude: 0.4, instrument: "二胡" },
                            { frequency: "500Hz", amplitude: 0.7, instrument: "二胡" },
                            { frequency: "1000Hz", amplitude: 0.5, instrument: "二胡" },
                            { frequency: "5000Hz", amplitude: 0.2, instrument: "二胡" },
                            { frequency: "20Hz", amplitude: 0.3, instrument: "古筝" }, // 新增古筝的数据点
                            { frequency: "100Hz", amplitude: 0.6, instrument: "古筝" },
                            { frequency: "500Hz", amplitude: 0.9, instrument: "古筝" },
                            { frequency: "1000Hz", amplitude: 0.7, instrument: "古筝" },
                            { frequency: "5000Hz", amplitude: 0.4, instrument: "古筝" }
                        ];

                        const svg = d3.select("#sound-spectrum svg");
                        const width = svg.node().getBoundingClientRect().width;
                        const height = svg.node().getBoundingClientRect().height;
                        const margin = { top: 20, right: 30, bottom: 30, left: 50 };
                        const innerWidth = width - margin.left - margin.right;
                        const innerHeight = height - margin.top - margin.bottom;

                        // 定义比例尺
                        const xScale = d3.scaleBand()
                            .domain(data.map(d => d.frequency))
                            .range([0, innerWidth])
                            .padding(0.2);

                        const yScale = d3.scaleLinear()
                            .domain([0, d3.max(data, d => d.amplitude)])
                            .range([innerHeight, 0]);

                        const colorScale = d3.scaleOrdinal()
                            .domain(["琵琶", "二胡", "古筝"])
                            .range(["#d4af37", "#ff6b6b", "#00ff00"]);

                        // 创建主图层
                        const g = svg.append("g")
                            .attr("transform", `translate(${margin.left},${margin.top})`);

                        // 添加渐变效果
                        const gradient = svg.append("defs").append("linearGradient")
                            .attr("id", "spectrum-gradient")
                            .attr("x1", "0%")
                            .attr("y1", "0%")
                            .attr("x2", "0%")
                            .attr("y2", "100%");

                        gradient.append("stop")
                            .attr("offset", "0%")
                            .attr("stop-color", "#d4af37");

                        gradient.append("stop")
                            .attr("offset", "100%")
                            .attr("stop-color", "#ff6b6b");

                        // 绘制频谱曲线，使用曲线插值让线条更平滑
                        const line = d3.line()
                            .x(d => xScale(d.frequency) + xScale.bandwidth() / 2)
                            .y(d => yScale(d.amplitude))
                            .curve(d3.curveCatmullRom.alpha(0.5)); // 使用 Catmull-Rom 曲线插值

                        const instruments = ["琵琶", "二胡"];
                        instruments.forEach(instrument => {
                            const instrumentData = data.filter(d => d.instrument === instrument);
                            g.append("path")
                                .datum(instrumentData)
                                .attr("fill", "none")
                                .attr("stroke", colorScale(instrument))
                                .attr("stroke-width", 2)
                                .attr("d", line);
                        });

                        // 移除添加数据点的代码，以去掉中间小点

                        // 添加坐标轴
                        g.append("g")
                            .attr("transform", `translate(0,${innerHeight})`)
                            .call(d3.axisBottom(xScale))
                            .selectAll("text")
                            .attr("fill", "#d4af37")
                            .style("font-family", "KingHwa_OldSong");

                        g.append("g")
                            .call(d3.axisLeft(yScale))
                            .selectAll("text")
                            .attr("fill", "#d4af37")
                            .style("font-family", "KingHwa_OldSong");

                        // 添加图例
                        const legend = svg.append("g")
                            .attr("class", "legend")
                            // 往右边移动 20 个单位
                            .attr("transform", `translate(${width - 100}, 10)`);

                        instruments.forEach((instrument, index) => {
                            legend.append("circle")
                                .attr("cx", 0)
                                .attr("cy", index * 20)
                                .attr("r", 5)
                                .attr("fill", colorScale(instrument));

                            legend.append("text")
                                .attr("x", 15)
                                .attr("y", index * 20 + 5)
                                .text(instrument)
                                .attr("fill", "#d4af37")
                                .style("font-family", "KingHwa_OldSong");
                        });
                    }

                    // 页面加载完成后初始化图表
                    window.addEventListener('load', initSoundSpectrum);
                </script>
                
                <div class="info-vis" id="historical-roles">
                    <h3 class="vis-title">历史角色</h3>
                    <svg width="100%" height="300"></svg>
                    <div class="chart-tooltip" style="position: absolute; display: none; background: rgba(0,0,0,0.8); color: #fff; padding: 8px; border-radius: 4px;"></div>
                </div>

                <script>
                    // 初始化历史角色演变图表
                    function initHistoricalRolesChart() {
                        // 模拟历史角色演变数据
                        const data = [
                            { role: "宫廷雅乐", time: "先秦 - 唐宋", influence: 8, color: "#8B4513" },
                            { role: "民间娱乐", time: "秦汉 - 现代", influence: 6, color: "#DAA520" },
                            { role: "宗教祭祀", time: "魏晋 - 明清", influence: 4, color: "#CD853F" },
                            { role: "文化交流", time: "唐代 - 现代", influence: 7, color: "#D2691E" },
                            { role: "教育传承", time: "近代 - 现代", influence: 5, color: "#BC8F8F" },
                            // 添加新数据，代表"艺术创作"角色
                            { role: "艺术创作", time: "明清 - 现代", influence: 6, color: "#FF69B4" },
                            // 添加新数据，代表"影视配乐"角色
                            { role: "影视配乐", time: "现代", influence: 3, color: "#00BFFF" }
                        ];

                        const svg = d3.select("#historical-roles svg");
                        const width = svg.node().getBoundingClientRect().width;
                        const height = svg.node().getBoundingClientRect().height;
                        const radius = Math.min(width, height) / 2;

                        const arc = d3.arc()
                            .innerRadius(radius * 0.4)
                            .outerRadius(radius * 0.8);

                        const pie = d3.pie()
                            .value(d => d.influence)
                            .sort(null);

                        const g = svg.append("g")
                            .attr("transform", `translate(${width/2},${height/2})`);

                        // 添加渐变效果
                        const gradient = svg.append("defs").selectAll("radialGradient")
                            .data(data)
                            .enter().append("radialGradient")
                            .attr("id", (d, i) => `gradient-${i}`)
                            .attr("cx", "50%")
                            .attr("cy", "50%")
                            .attr("r", "50%");

                        gradient.append("stop")
                            .attr("offset", "0%")
                            .attr("stop-color", (d) => d3.color(d.color).brighter(0.5));

                        gradient.append("stop")
                            .attr("offset", "100%")
                            .attr("stop-color", (d) => d3.color(d.color).darker(0.5));

                        // 绘制饼图切片
                        const slices = g.selectAll(".arc")
                            .data(pie(data))
                            .enter().append("path")
                            .attr("class", "arc")
                            .attr("d", arc)
                            .attr("fill", (d, i) => `url(#gradient-${i})`)
                            .on("mouseover", function(event, d) {
                                d3.select(this).transition()
                                    .duration(200)
                                    .attr("transform", "scale(1.05)");
                                const tooltip = d3.select(".chart-tooltip");
                                tooltip.style("display", "block")
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 20) + "px")
                                    // 仅显示对应 time
                                    .html(`时期: ${d.data.time}`);
                            })
                            .on("mouseout", function() {
                                d3.select(this).transition()
                                    .duration(200)
                                    .attr("transform", "scale(1)");
                                d3.select(".chart-tooltip").style("display", "none");
                            });

                        // 添加文本标签
                        g.selectAll(".label")
                            .data(pie(data))
                            .enter().append("text")
                            .attr("class", "label")
                            .attr("transform", d => `translate(${arc.centroid(d)})`)
                            .attr("dy", ".35em")
                            .style("text-anchor", "middle")
                            .style("fill", "#fff")
                            .text(d => d.data.role);
                    }

                    // 页面加载完成后初始化图表
                    window.addEventListener('load', initHistoricalRolesChart);
                </script>
                </div>
        </section>
        <!-- 名曲鉴赏部分 -->
        <section id="masterpieces" class="page-section">
            <div class="left-column">
                <div class="info-vis" id="pipa-masterpieces">
                    <h3 class="vis-title">琵琶名曲情感图谱</h3>
                    <div class="flourish-embed flourish-hierarchy" data-src="visualisation/23572524"><script src="https://public.flourish.studio/resources/embed.js"></script><noscript><img src="https://public.flourish.studio/visualisation/23572524/thumbnail" width="100%" alt="hierarchy visualization" /></noscript></div>
                </div>
                
                <div class="info-vis" id="erhu-masterpieces">
                    <h3 class="vis-title">二胡名曲情感图谱</h3>
                    <div class="flourish-embed flourish-hierarchy" data-src="visualisation/23573221"><script src="https://public.flourish.studio/resources/embed.js"></script><noscript><img src="https://public.flourish.studio/visualisation/23573221/thumbnail" width="100%" alt="hierarchy visualization" /></noscript></div>                </div>
                
                <div class="info-vis" id="composition-periods">
                    <h3 class="vis-title">创作年代分布</h3>
                    <div class="flourish-embed flourish-scatter" data-src="visualisation/23573297"><script src="https://public.flourish.studio/resources/embed.js"></script><noscript><img src="https://public.flourish.studio/visualisation/23573297/thumbnail" width="100%" alt="scatter visualization" /></noscript></div>                </div>
            
            </div>
            
            <div class="center-column">
                <h2>千古绝响</h2>
                <p>中国传统弦乐名曲凝聚了千百年来的艺术智慧，既有描绘自然风光的写景之作，也有抒发人生感悟的抒情之篇。</p>
                
                <div class="main-visual">
                    <img src="static/img/pipa01.svg" alt="演奏" height="1000" style="transform: scale(0.6) translate(250px, -200px);">
                    <img src="static/img/erhu01.svg" alt="演奏" height="1000" style="transform: scale(0.6) translate(-250px, 239px);">
                </div>
                
                <!-- 名曲滚动列表容器 -->
                <div class="masterpiece-scroll-container">
                    <div class="scroll-gradient-left"></div>
                    <div class="masterpiece-list">
                        <div class="masterpiece-item">
                            <h4>十面埋伏</h4>
                            <p class="meta">琵琶 | 清代 | 佚名</p>
                            <p class="desc">描绘楚汉相争的宏大场面，以丰富的演奏技法展现战场气氛。</p>
                        </div>
                        <div class="masterpiece-item">
                            <h4>阳春白雪</h4>
                            <p class="meta">琵琶 | 唐代 | 佚名</p>
                            <p class="desc">展现冬去春来的自然景象，琵琶音色清丽典雅。</p>
                        </div>
                        <div class="masterpiece-item">
                            <h4>二泉映月</h4>
                            <p class="meta">二胡 | 1950年 | 华彦钧</p>
                            <p class="desc">借泉水月影抒发人生感慨，二胡音色凄婉动人。</p>
                        </div>
                        <div class="masterpiece-item">
                            <h4>梁祝</h4>
                            <p class="meta">二胡 | 1959年 | 何占豪</p>
                            <p class="desc">改编自小提琴协奏曲，展现凄美的爱情故事。</p>
                        </div>
                        <div class="masterpiece-item">
                            <h4>春江花月夜</h4>
                            <p class="meta">琵琶 | 唐代 | 佚名</p>
                            <p class="desc">描绘春夜江边美景，琵琶音色优美动人。</p>
                        </div>
                    </div>
                    <div class="scroll-gradient-right"></div>
                </div>

                <style>
                    /* 名曲列表容器样式 */
                    .masterpiece-scroll-container {
                        position: relative;
                        width: 100%;
                        height: 150px;
                        margin: 20px 0;
                        overflow: hidden;
                    }

                    /* 渐变遮罩 */
                    .scroll-gradient-left, .scroll-gradient-right {
                        position: absolute;
                        top: 0;
                        width: 80px;
                        height: 100%;
                        z-index: 2;
                        pointer-events: none;
                    }

                    .scroll-gradient-left {
                        left: 0;
                        background: linear-gradient(to right, #410277, transparent);
                    }

                    .scroll-gradient-right {
                        right: 0;
                        background: linear-gradient(to left, #410277, transparent);
                    }

                    /* 名曲列表样式 */
                    .masterpiece-list {
                        display: flex;
                        gap: 20px;
                        padding: 10px;
                        animation: scrollList 30s linear infinite;
                        cursor: grab;
                    }

                    .masterpiece-list:hover {
                        animation-play-state: paused;
                    }

                    /* 名曲项目样式 */
                    .masterpiece-item {
                        min-width: 250px;
                        padding: 15px;
                        background: rgba(212, 175, 55, 0.1);
                        border: 1px solid rgba(212, 175, 55, 0.3);
                        border-radius: 8px;
                        transition: all 0.3s ease;
                    }

                    .masterpiece-item:hover {
                        transform: translateY(-5px);
                        background: rgba(212, 175, 55, 0.2);
                        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                    }

                    .masterpiece-item h4 {
                        color: #d4af37;
                        margin-bottom: 5px;
                        font-size: 1.2em;
                    }

                    .masterpiece-item .meta {
                        color: #a08a3c;
                        font-size: 0.9em;
                        margin-bottom: 8px;
                    }

                    .masterpiece-item .desc {
                        color: #d4af37;
                        font-size: 0.9em;
                        line-height: 1.4;
                    }

                    /* 滚动动画 */
                    @keyframes scrollList {
                        0% {
                            transform: translateX(0);
                        }
                        100% {
                            transform: translateX(-100%);
                        }
                    }
                </style>

                <script>
                    // 实现拖拽滚动
                    const list = document.querySelector('.masterpiece-list');
                    let isDown = false;
                    let startX;
                    let scrollLeft;

                    list.addEventListener('mousedown', (e) => {
                        isDown = true;
                        list.style.cursor = 'grabbing';
                        startX = e.pageX - list.offsetLeft;
                        scrollLeft = list.scrollLeft;
                    });

                    list.addEventListener('mouseleave', () => {
                        isDown = false;
                        list.style.cursor = 'grab';
                    });

                    list.addEventListener('mouseup', () => {
                        isDown = false;
                        list.style.cursor = 'grab';
                    });

                    list.addEventListener('mousemove', (e) => {
                        if(!isDown) return;
                        e.preventDefault();
                        const x = e.pageX - list.offsetLeft;
                        const walk = (x - startX) * 2;
                        list.scrollLeft = scrollLeft - walk;
                    });
                </script>
                
                <div class="masterpieces-content">
                    <p style="font-family: 'KingHwa_OldSong', serif; font-size: 0.9em;">琵琶名曲《十面埋伏》以丰富的技法描绘楚汉相争的激烈战场，《阳春白雪》则表现了冬去春来的自然景象。二胡名曲《二泉映月》借无锡惠山泉水月影抒发人生感慨，《赛马》则生动表现了草原赛马的欢快场景。</p>
                    <p style="font-family: 'KingHwa_OldSong', serif; font-size: 0.9em;">这些名曲不仅技术精湛，更蕴含深厚的文化内涵。演奏时讲究"意在音先"，通过音色的变化、节奏的处理和气息的掌控，将中国美学中的虚实相生、动静结合等理念表现得淋漓尽致。</p>
                </div>
            </div>
            
            <div class="right-column">
                <div class="info-vis" id="emotional-journey">
                    <h3 class="vis-title"> <br> <br> 年代情感变化</h3>
<div class="flourish-embed flourish-chart" data-src="visualisation/23573785" style="height:400px"><script src="https://public.flourish.studio/resources/embed.js"></script><noscript><img src="https://public.flourish.studio/visualisation/23573785/thumbnail" width="100%" alt="chart visualization" /></noscript></div>                </div>
<div class="info-vis" id="rhythm-patterns">
    <h3 class="vis-title">节奏模式分析</h3>
    <svg width="100%" height="250"></svg>
</div>

<script>
// 初始化雷达图
function initRhythmPatterns() {
    // 数据准备
    const data = [
        {axis: "快板", value: 0.8},
        {axis: "中板", value: 0.6}, 
        {axis: "慢板", value: 0.4},
        {axis: "散板", value: 0.7},
        {axis: "自由板", value: 0.5}
    ];

    const svg = d3.select("#rhythm-patterns svg");
    const width = svg.node().getBoundingClientRect().width;
    const height = svg.node().getBoundingClientRect().height;
    const radius = Math.min(width, height) / 2 - 30;

    // 创建比例尺和角度计算
    const angleScale = d3.scaleLinear()
        .domain([0, data.length])
        .range([0, 2 * Math.PI]);

    const radiusScale = d3.scaleLinear()
        .domain([0, 1])
        .range([0, radius]);

    // 创建雷达图路径生成器
    const radarLine = d3.lineRadial()
        .radius(d => radiusScale(d.value))
        .angle((d, i) => angleScale(i));

    // 绘制雷达图
    const g = svg.append("g")
        .attr("transform", `translate(${width/2}, ${height/2})`);

    // 绘制背景圆环
    const levels = 5;
    for(let i = 0; i < levels; i++) {
        g.append("circle")
            .attr("r", radius * (i + 1) / levels)
            .attr("fill", "none")
            .attr("stroke", "#d4af37")
            .attr("stroke-width", 0.5)
            .attr("opacity", 0.3);
    }

    // 绘制轴线
    data.forEach((d, i) => {
        const angle = angleScale(i);
        g.append("line")
            .attr("x1", 0)
            .attr("y1", 0)
            .attr("x2", radius * Math.cos(angle - Math.PI/2))
            .attr("y2", radius * Math.sin(angle - Math.PI/2))
            .attr("stroke", "#d4af37")
            .attr("stroke-width", 0.5)
            .attr("opacity", 0.5);

        // 添加轴标签
        g.append("text")
            .attr("x", (radius + 20) * Math.cos(angle - Math.PI/2))
            .attr("y", (radius + 20) * Math.sin(angle - Math.PI/2))
            .attr("text-anchor", "middle")
            .attr("fill", "#d4af37")
            .attr("font-family", "KingHwa_OldSong")
            .attr("font-size", "12px")
            .text(d.axis);
    });

    // 绘制数据区域
    // 创建连接线路径
    let radarPath = g.append("path")
        .datum(data)
        .attr("d", radarLine)
        .attr("fill", "rgba(212, 175, 55, 0.2)")
        .attr("stroke", "#d4af37")
        .attr("stroke-width", 0.1);

    // 确保数据点首尾相连
    let closedData = [...data, data[0]];
    
    // 添加数据点
    g.selectAll(".data-point")
        .data(closedData)
        .enter()
        .append("circle")
        .attr("class", "data-point")
        .attr("cx", (d, i) => radiusScale(d.value) * Math.cos(angleScale(i % data.length) - Math.PI/2))
        .attr("cy", (d, i) => radiusScale(d.value) * Math.sin(angleScale(i % data.length) - Math.PI/2))
        .attr("r", 4)
        .attr("fill", "#ffe26e");

    // 添加交互效果
    g.selectAll(".data-point")
        .on("mouseover", function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr("r", 6)
                .attr("fill", "#ff6b6b");
            // 添加数值提示
            g.append("text")
                .attr("class", "value-label")
                .attr("x", event.target.cx.baseVal.value)
                .attr("y", event.target.cy.baseVal.value - 10)
                .attr("text-anchor", "middle")
                .attr("fill", "#ffe26e")
                .text(d.value * 100 + "%");
        })
        .on("mouseout", function() {
            d3.select(this)
                .transition()
                .duration(200)
                .attr("r", 4)
                .attr("fill", "#ffe26e");

            g.selectAll(".value-label").remove();
        });
}

// 页面加载完成后初始化
document.addEventListener("DOMContentLoaded", initRhythmPatterns);
</script>
                
<div class="info-vis" id="modern-adaptations">
    <h3 class="vis-title">现代改编情况</h3>
    <svg width="100%" height="400"></svg>
</div>

<script>
// 初始化现代改编情况图表
function initModernAdaptations() {
    const data = [
        { genre: "流行音乐", count: 45, year: 2020 },
        { genre: "电子音乐", count: 30, year: 2020 },
        { genre: "爵士乐", count: 25, year: 2020 },
        { genre: "古典音乐", count: 35, year: 2020 },
        { genre: "世界音乐", count: 20, year: 2020 }
    ];

    const svg = d3.select("#modern-adaptations svg");
    const width = svg.node().getBoundingClientRect().width;
    const height = 250;
    const margin = { top: 20, right: 20, bottom: 30, left: 40 };

    const x = d3.scaleBand()
        .domain(data.map(d => d.genre))
        .range([margin.left, width - margin.right])
        .padding(0.1);

    const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.count)])
        .range([height - margin.bottom, margin.top]);

    // 添加渐变效果
    const gradient = svg.append("defs")
        .append("linearGradient")
        .attr("id", "bar-gradient")
        .attr("x1", "0%")
        .attr("y1", "0%")
        .attr("x2", "0%")
        .attr("y2", "100%");

    gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", "#d4af37");

    gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", "#4b0082");

    // 绘制柱状图
    svg.selectAll("rect")
        .data(data)
        .join("rect")
        .attr("x", d => x(d.genre))
        .attr("y", height - margin.bottom)
        .attr("width", x.bandwidth())
        .attr("height", 0)
        .attr("fill", "url(#bar-gradient)")
        .transition()
        .duration(1000)
        .attr("y", d => y(d.count))
        .attr("height", d => height - margin.bottom - y(d.count));

    // 添加x轴
    svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x))
        .selectAll("text")
        .attr("fill", "#d4af37")
        .attr("transform", "rotate(-45)")
        .attr("text-anchor", "end");

    // 添加y轴
    svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y))
        .selectAll("text")
        .attr("fill", "#d4af37");

    // 添加数值标签
    svg.selectAll(".value-label")
        .data(data)
        .join("text")
        .attr("class", "value-label")
        .attr("x", d => x(d.genre) + x.bandwidth() / 2)
        .attr("y", d => y(d.count) - 5)
        .attr("text-anchor", "middle")
        .attr("fill", "#d4af37")
        .attr("opacity", 0)
        .text(d => d.count)
        .transition()
        .duration(1000)
        .attr("opacity", 1);

    // 添加交互效果
    svg.selectAll("rect")
        .on("mouseover", function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr("fill", "#ff6b6b");
        })
        .on("mouseout", function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr("fill", "url(#bar-gradient)");
        });
}

// 页面加载完成后初始化图表
document.addEventListener("DOMContentLoaded", initModernAdaptations);
                    </script>
                </div>
        </section>
        
        <!-- 尾声部分 -->
        <section id="epilogue" class="page-section">
            <div class="left-column" style="width: 70%;">
                

            </div>
            
            <div class="center-column"style="width: 400% !important;">
                <h2>尾声-弦音永续</h2>
                <p>中国传统弦乐作为中华文化的重要载体，在新时代焕发出新的生命力，既坚守传统精髓，又拥抱创新发展。</p>
                
                <div class="main-visual" >
                    <div class="scroll-gradient-left"></div>
                    <div class="flourish-embed flourish-webgl" data-src="visualisation/23569810" style="width: 100% !important;">
                        <script src="https://public.flourish.studio/resources/embed.js"></script>
                        <noscript>
                            <img src="https://public.flourish.studio/visualisation/23569810/thumbnail" 
                                width="100%" 
                                alt="webgl visualization" 
                                style="border-radius: 50px;" />
                        </noscript>
                    </div>        
                    <div class="scroll-gradient-right"></div>        
                </div>
                
                <div class="epilogue-content">
                    <p style="font-family: 'KingHwa_OldSong', serif; font-size: 1em;">近年来，中国传统弦乐在国际舞台大放异彩，众多演奏家将中国乐器与西方音乐形式相结合，创作出许多跨界作品。同时，传统弦乐教育日益普及，越来越多的年轻人开始学习这些古老乐器。</p>
                    <p style="font-family: 'KingHwa_OldSong', serif; font-size: 1em;">展望未来，中国传统弦乐将继续在保持民族特色的基础上创新发展，用独特的音乐语言讲述中国故事，促进中外文化交流。这些历经千年沉淀的艺术瑰宝，必将在新时代奏响更加动人的乐章。</p>
                </div>
                <div style="font-family: 'KingHwa_OldSong', serif; transform: translateY(100px);">本作品总访问次数： <img src="https://w.saobby.com/w/tax2po27" style="display: inline; height: 2em; vertical-align: middle;"> 次</div>
                <div style="font-family: 'KingHwa_OldSong', serif; transform: translateY(105px); font-size: 0.8em; color: rgba(212, 175, 55, 0.7);">
                    作者：陈玙璠 图形：江盈盈 四川农业大学艺术与传媒学院<br><br>参考文献：<br>[1] 高崇民. 中国乐器史. 北京: 文化艺术出版社, 2005.<br>
                    [2] 林石城. 琵琶艺术论集. 北京: 中央音乐学院出版社, 2005.<br>
                    [3] 杨荫浏. 中国古代音乐史稿. 北京: 人民音乐出版社, 1981.<br>
                    [4] 吴钊. 中国古琴艺术. 北京: 人民音乐出版社, 2003.<br>
                    [5] 荣斋. 弦索备考. 北京: 中国艺术研究院馆藏善本, 1814.<br>
                    [6] 林石城. 琵琶初探. 广州音乐学院学报, 1982(1): 45 - 52.<br>
                    [7] 周红. 论琵琶演奏风格的艺术特征——以《养正轩琵琶谱》为例. 黄钟(武汉音乐学院学报), 2011(3): 78 - 85.<br>
                    [8] 李跞. 琵琶浦东派文曲、武曲辩证弹法研究. 艺术评鉴, 2017(11): 102 - 108.<br><br>
                    <p>赣ICP备18013125号-3</a></p>
            </div>
        </div>

            <div class="right-column" style="width: 70%;">
            </div>
        </section>
    </div>
    
    <!-- 五音特效 -->
    <div id="music-notes-container"></div>
    
    <script>
        // 五音特效生成
        function createMusicNotes() {
            const notes = ['宫', '商', '角', '徵', '羽'];
            const container = document.getElementById('music-notes-container');
            
            for (let i = 0; i < 20; i++) {
                const note = document.createElement('div');
                note.className = 'music-note';
                note.textContent = notes[Math.floor(Math.random() * notes.length)];
                
                // 随机位置和动画延迟
                const left = Math.random() * 100;
                const delay = Math.random() * 15;
                const duration = 10 + Math.random() * 10;
                const size = 1 + Math.random() * 2;
                
                note.style.left = `${left}%`;
                note.style.animationDelay = `${delay}s`;
                note.style.animationDuration = `${duration}s`;
                note.style.fontSize = `${size}rem`;
                note.style.opacity = 0.1 + Math.random() * 0.2;
                
                container.appendChild(note);
            }
        }
        
        // 初始化进入动画
        function initEntranceAnimations() {
            // 标题动画
            anime({
                targets: '.main-title',
                opacity: [0, 1],
                translateY: [-20, 0],
                easing: 'easeOutExpo',
                duration: 1500,
                delay: 300
            });
            
            // 主内容区域动画
            anime({
                targets: '.main-content',
                opacity: [0, 1],
                easing: 'easeOutExpo',
                duration: 1500,
                delay: 500
            });
            
            // 页面部分动画
            const sections = document.querySelectorAll('.page-section');
            sections.forEach((section, index) => {
                // 只对当前可见的部分应用动画
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // 页面部分淡入
                            anime({
                                targets: section,
                                opacity: [0, 1],
                                translateY: [30, 0],
                                easing: 'easeOutExpo',
                                duration: 1200,
                                complete: function() {
                                    // 左右列动画
                                    anime({
                                        targets: section.querySelector('.left-column'),
                                        opacity: [0, 1],
                                        translateX: [-30, 0],
                                        easing: 'easeOutExpo',
                                        duration: 1000
                                    });
                                    
                                    anime({
                                        targets: section.querySelector('.right-column'),
                                        opacity: [0, 1],
                                        translateX: [30, 0],
                                        easing: 'easeOutExpo',
                                        duration: 1000
                                    });
                                    
                                    // 中间列动画
                                    anime({
                                        targets: section.querySelector('.center-column'),
                                        opacity: [0, 1],
                                        translateY: [30, 0],
                                        easing: 'easeOutExpo',
                                        duration: 1000,
                                        delay: 200
                                    });
                                    
                                    // 信息图表动画
                                    anime({
                                        targets: section.querySelectorAll('.info-vis'),
                                        opacity: [0, 1],
                                        scale: [0.9, 1],
                                        easing: 'easeOutExpo',
                                        duration: 1200,
                                        delay: anime.stagger(100)
                                    });
                                    
                                    // 图表标题动画
                                    anime({
                                        targets: section.querySelectorAll('.vis-title'),
                                        opacity: [0, 1],
                                        easing: 'easeOutExpo',
                                        duration: 1000,
                                        delay: anime.stagger(100, {start: 200})
                                    });
                                    
                                    // 主视觉图片容器动画
                                    anime({
                                        targets: section.querySelector('.main-visual'),
                                        opacity: [0, 1],
                                        easing: 'easeOutExpo',
                                        duration: 1000,
                                        delay: 400
                                    });
                                    
                                    // 乐器图片动画
                                    anime({
                                        targets: section.querySelectorAll('.instrument-img'),
                                        opacity: [0, 1],
                                        scale: [0.8, 1],
                                        rotate: [-5, 0],
                                        easing: 'easeOutElastic(1, .6)',
                                        duration: 1500,
                                        delay: anime.stagger(200, {start: 600})
                                    });
                                }
                            });
                            
                            // 观察到后取消观察
                            observer.unobserve(entry.target);
                        }
                    });
                }, {threshold: 0.1});
                
                observer.observe(section);
            });
        }
        
        // 时间线导航动画
        function setupTimelineNav() {
            const timelineItems = document.querySelectorAll('.timeline-item');
            const sections = document.querySelectorAll('.page-section');
            const timelineLine = document.querySelector('.timeline-line');
            
            // 创建波形动画
            const wavePath = document.querySelector('.timeline-wave path');
            anime({
                targets: wavePath,
                d: [
                    {value: 'M0,0 C20,50 30,100 50,150 C70,200 80,250 100,300 L100,500 L0,500 Z'},
                    {value: 'M0,0 C20,70 40,120 50,170 C60,220 80,270 100,320 L100,500 L0,500 Z'},
                    {value: 'M0,0 C10,40 30,90 50,140 C70,190 90,240 100,290 L100,500 L0,500 Z'}
                ],
                easing: 'easeInOutSine',
                duration: 8000,
                direction: 'alternate',
                loop: true
            });
            
            // 滚动检测
            window.addEventListener('scroll', () => {
                const scrollPosition = window.scrollY + window.innerHeight / 2;
                
                // 更新时间线指示器位置
                const lineHeight = Math.min(70, (scrollPosition / document.body.scrollHeight) * 70);
                timelineLine.style.height = `${lineHeight}vh`;
                
                // 检查当前所在部分
                sections.forEach((section, index) => {
                    const sectionTop = section.offsetTop;
                    const sectionBottom = sectionTop + section.offsetHeight;
                    
                    if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
                        timelineItems.forEach(item => item.classList.remove('active'));
                        timelineItems[index].classList.add('active');
                    }
                });
            });
            
            // 点击导航
            timelineItems.forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.getAttribute('data-section');
                    const section = document.getElementById(sectionId);
                    
                    window.scrollTo({
                        top: section.offsetTop,
                        behavior: 'smooth'
                    });
                    
                    // 点击动画
                    anime({
                        targets: item,
                        scale: [1, 1.3, 1],
                        duration: 600,
                        easing: 'easeOutElastic'
                    });
                });
            });
        }
        
        // 初始化所有可视化图表
        function initEvolutionMap() {
            const data = [
                {name: "琴", x: 100, y: 50, era: "商周", connections: ["琵琶", "古琴"]},
                {name: "瑟", x: 200, y: 50, era: "商周", connections: ["古筝"]},
                {name: "琵琶", x: 80, y: 150, era: "秦汉", connections: ["阮", "月琴"]},
                {name: "古琴", x: 180, y: 150, era: "秦汉", connections: []},
                {name: "古筝", x: 280, y: 150, era: "秦汉", connections: []},
                {name: "阮", x: 60, y: 250, era: "魏晋", connections: ["三弦"]},
                {name: "月琴", x: 160, y: 250, era: "魏晋", connections: []},
                {name: "箜篌", x: 260, y: 250, era: "魏晋", connections: []},
                {name: "三弦", x: 60, y: 350, era: "唐宋", connections: []},
                {name: "二胡", x: 160, y: 350, era: "唐宋", connections: ["高胡", "板胡"]},
                {name: "高胡", x: 120, y: 450, era: "明清", connections: []},
                {name: "板胡", x: 220, y: 450, era: "明清", connections: []}
            ];
            
            // 创建连接数据
            const links = [];
            data.forEach(source => {
                source.connections.forEach(targetName => {
                    const target = data.find(d => d.name === targetName);
                    if (target) {
                        links.push({source, target});
                    }
                });
            });
            
            const svg = d3.select("#initInstrumentOrigins svg");
            const width = svg.node().getBoundingClientRect().width;
            const height = 500;
            
            svg.attr("height", height);
            
            // 绘制时间轴背景
            const eras = ["商周", "秦汉", "魏晋", "唐宋", "明清", "近代"];
            const eraHeight = height / eras.length;
            
            svg.selectAll(".era-background")
                .data(eras)
                .enter()
                .append("rect")
                .attr("class", "era-background")
                .attr("x", 0)
                .attr("y", (d, i) => i * eraHeight)
                .attr("width", width)
                .attr("height", eraHeight)
                .attr("fill", (d, i) => i % 2 === 0 ? "rgba(42, 8, 69, 0.1)" : "rgba(212, 175, 55, 0.1)");
            
            // 添加时代标签
            svg.selectAll(".era-label")
                .data(eras)
                .enter()
                .append("text")
                .attr("class", "era-label")
                .attr("x", 20)
                .attr("y", (d, i) => i * eraHeight + 30)
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 16)
                .text(d => d);
            
            // 绘制连接线
            svg.selectAll(".evolution-link")
                .data(links)
                .enter()
                .append("path")
                .attr("class", "evolution-link")
                .attr("d", d => {
                    const sourceX = d.source.x;
                    const sourceY = d.source.y;
                    const targetX = d.target.x;
                    const targetY = d.target.y;
                    return `M${sourceX},${sourceY} C${sourceX},${(sourceY + targetY) / 2} ${targetX},${(sourceY + targetY) / 2} ${targetX},${targetY}`;
                })
                .attr("fill", "none")
                .attr("stroke", "#8b4513")
                .attr("stroke-width", 2)
                .attr("opacity", 0.6);
            
            // 绘制乐器节点
            const nodes = svg.selectAll(".evolution-node")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "evolution-node")
                .attr("transform", d => `translate(${d.x}, ${d.y})`);
            
            nodes.append("circle")
                .attr("r", 20)
                .attr("fill", d => {
                    if (d.era === "商周") return "#8B4513";
                    if (d.era === "秦汉") return "#DAA520";
                    if (d.era === "魏晋") return "#4B0082";
                    if (d.era === "唐宋") return "#CD5C5C";
                    return "#4682B4";
                })
                .attr("stroke", "#2a0845")
                .attr("stroke-width", 2);
            
            nodes.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", ".3em")
                .attr("fill", "#e6d5b8")
                .attr("font-family", "KingHwa_OldSong")
                .text(d => d.name);
            
            // 添加交互效果
            nodes.on("mouseover", function(event, d) {
                // 高亮当前节点
                d3.select(this).select("circle")
                    .attr("r", 25)
                    .attr("fill", "#ff6b6b");
                
                // 高亮相关连接
                svg.selectAll(".evolution-link")
                    .attr("stroke", link => {
                        if (link.source === d || link.target === d) {
                            return "#ff6b6b";
                        }
                        return "#8b4513";
                    })
                    .attr("stroke-width", link => {
                        if (link.source === d || link.target === d) {
                            return 3;
                        }
                        return 2;
                    })
                    .attr("opacity", link => {
                        if (link.source === d || link.target === d) {
                            return 1;
                        }
                        return 0.2;
                    });
                
                // 添加信息提示
                const tooltip = svg.append("g")
                    .attr("class", "evolution-tooltip")
                    .attr("transform", `translate(${d.x}, ${d.y - 40})`);
                
                tooltip.append("rect")
                    .attr("width", 120)
                    .attr("height", 30)
                    .attr("x", -60)
                    .attr("y", -15)
                    .attr("rx", 5)
                    .attr("ry", 5)
                    .attr("fill", "rgba(42, 8, 69, 0.8)")
                    .attr("stroke", "#d4af37");
                
                tooltip.append("text")
                    .attr("text-anchor", "middle")
                    .attr("fill", "#d4af37")
                    .text(`${d.name} (${d.era})`);
            })
            .on("mouseout", function() {
                // 恢复节点样式
                d3.select(this).select("circle")
                    .attr("r", 20)
                    .attr("fill", d => {
                        if (d.era === "商周") return "#8B4513";
                        if (d.era === "秦汉") return "#DAA520";
                        if (d.era === "魏晋") return "#4B0082";
                        if (d.era === "唐宋") return "#CD5C5C";
                        return "#4682B4";
                    });
                
                // 恢复连接样式
                svg.selectAll(".evolution-link")
                    .attr("stroke", "#8b4513")
                    .attr("stroke-width", 2)
                    .attr("opacity", 0.6);
                
                // 移除提示
                svg.selectAll(".evolution-tooltip").remove();
            });
        }
        
        function initAllVisualizations() {
            // 历史发展部分图表 - 已实现的函数
            initHistoryTimeline();
            initDynastyDistribution();
            initEvolutionMap();
            initInstrumentOrigins();
            initDynastyComparison();
            initHistoricalEvents();
            // initTechniqueEvolution(); // 已删除
            // initMaterialChanges(); // 已删除
            initSankeyDiagram();
            initBubbleChart();
            initForceDirectedGraph();
            initRadarChart();
            initChordDiagram();
            initClassificationVis();
            
            // 以下是尚未实现的函数的空实现，避免JavaScript错误
            console.log("注意：部分可视化图表尚未实现，仅显示已完成的图表");
        }
        
        // 为未实现的函数添加空实现
        function initFamousMusicians() {
            console.log("initFamousMusicians 函数尚未实现");
        }
        

        
        function initInstrumentFamily() {
            console.log("initInstrumentFamily 函数尚未实现");
        }
        
        function initRegionalDistribution() {
            console.log("initRegionalDistribution 函数尚未实现");
        }
        
        function initTuningSystems() {
            console.log("initTuningSystems 函数尚未实现");
        }
        
        function initPlayingPositions() {
            console.log("initPlayingPositions 函数尚未实现");
        }
        
        function initSoundCharacteristics() {
            console.log("initSoundCharacteristics 函数尚未实现");
        }
        
        function initRepertoireAnalysis() {
            console.log("initRepertoireAnalysis 函数尚未实现");
        }
        
        function initCulturalSignificance() {
            console.log("initCulturalSignificance 函数尚未实现");
        }
        
        
        function initAcousticPrinciples() {
            console.log("initAcousticPrinciples 函数尚未实现");
        }
        
        function initPerformanceContexts() {
            console.log("initPerformanceContexts 函数尚未实现");
        }
        
        function initPipaStructure() {
            console.log("initPipaStructure 函数尚未实现");
        }
        
        function initErhuStructure() {
            console.log("initErhuStructure 函数尚未实现");
        }
        
        function initPlayingTechniques() {
            console.log("initPlayingTechniques 函数尚未实现");
        }
        
        function initSoundSpectrum() {
            console.log("initSoundSpectrum 函数尚未实现");
        }
        
        function initRepertoireOverlap() {
            console.log("initRepertoireOverlap 函数尚未实现");
        }
        
        function initHistoricalRoles() {
            console.log("initHistoricalRoles 函数尚未实现");
        }
        
        function initCulturalAssociations() {
            console.log("initCulturalAssociations 函数尚未实现");
        }
        
        function initModernInnovations() {
            console.log("initModernInnovations 函数尚未实现");
        }
        
        function initLearningCurves() {
            console.log("initLearningCurves 函数尚未实现");
        }
        
        function initGlobalInfluence() {
            console.log("initGlobalInfluence 函数尚未实现");
        }
        
        function initPipaMasterpieces() {
            console.log("initPipaMasterpieces 函数尚未实现");
        }
        
        function initErhuMasterpieces() {
            console.log("initErhuMasterpieces 函数尚未实现");
        }
        
        function initCompositionPeriods() {
            console.log("initCompositionPeriods 函数尚未实现");
        }
        
        function initThematicAnalysis() {
            console.log("initThematicAnalysis 函数尚未实现");
        }
        
        function initStructuralPatterns() {
            console.log("initStructuralPatterns 函数尚未实现");
        }
        
        function initEmotionalJourney() {
            console.log("initEmotionalJourney 函数尚未实现");
        }
        
        function initPerformanceVersions() {
            console.log("initPerformanceVersions 函数尚未实现");
        }
        
        function initCulturalReferences() {
            console.log("initCulturalReferences 函数尚未实现");
        }
        
        function initRhythmPatterns() {
            console.log("initRhythmPatterns 函数尚未实现");
        }
        
        function initModernAdaptations() {
            console.log("initModernAdaptations 函数尚未实现");
        }
        
        function initModernDevelopments() {
            console.log("initModernDevelopments 函数尚未实现");
        }
        
        function initGlobalSpread() {
            console.log("initGlobalSpread 函数尚未实现");
        }
        
        function initEducationGrowth() {
            console.log("initEducationGrowth 函数尚未实现");
        }
        
        function initInnovationTrends() {
            console.log("initInnovationTrends 函数尚未实现");
        }
        
        function initCulturalImpact() {
            console.log("initCulturalImpact 函数尚未实现");
        }
        
        function initFutureProjections() {
            console.log("initFutureProjections 函数尚未实现");
        }
        
        function initCrossCultural() {
            console.log("initCrossCultural 函数尚未实现");
        }
        
        function initDigitalInnovations() {
            console.log("initDigitalInnovations 函数尚未实现");
        }
        
        function initYouthEngagement() {
            console.log("initYouthEngagement 函数尚未实现");
        }
        
        function initPreservationEfforts() {
            console.log("initPreservationEfforts 函数尚未实现");
        }
// 注意：所有图表初始化已移至 initAllVisualizations 函数中，避免重复初始化
        function initHistoryTimeline() {
            const data = [
                {year: "商周", event: "琴瑟出现", importance: 3, details: "商周时期，琴瑟等弦乐器已经在礼乐制度中占据重要地位，主要用于祭祀和宫廷场合。", startYear: "-1046", endYear: "-221", color: "#8B4513", instruments: ["琴", "瑟"]},
                {year: "秦汉", event: "琵琶传入", importance: 5, details: "秦汉时期，随着丝绸之路的开通，西域琵琶传入中原，并逐渐与中国本土文化融合。", startYear: "-221", endYear: "220", color: "#DAA520", instruments: ["琵琶", "阮"]},
                {year: "魏晋", event: "阮咸定型", importance: 4, details: "魏晋南北朝时期，阮咸等弦乐器的形制逐渐定型，文人雅士开始广泛使用弦乐器抒发情感。", startYear: "220", endYear: "581", color: "#4B0082", instruments: ["阮咸", "古琴"]},
                {year: "隋唐", event: "琵琶鼎盛", importance: 8, details: "隋唐时期是中国弦乐发展的黄金时代，特别是琵琶艺术达到了前所未有的高度，出现了许多著名的琵琶曲。", startYear: "581", endYear: "907", color: "#CD5C5C", instruments: ["琵琶", "古筝", "阮咸"]},
                {year: "宋元", event: "三弦兴起", importance: 6, details: "宋元时期，三弦等新型弦乐器兴起，弦乐艺术在民间得到广泛传播，出现了许多民间艺人。", startYear: "960", endYear: "1368", color: "#4682B4", instruments: ["三弦", "古琴", "琵琶"]},
                {year: "明清", event: "胡琴普及", importance: 7, details: "明清时期，胡琴类乐器得到普及和发展，戏曲音乐中的弦乐伴奏技巧日益成熟。", startYear: "1368", endYear: "1912", color: "#2E8B57", instruments: ["二胡", "京胡", "琵琶", "古筝"]},
                {year: "近代", event: "二胡革新", importance: 6, details: "近现代时期，二胡等传统弦乐器经历了革新，融入了西方音乐元素，创作了大量新曲目。", startYear: "1912", endYear: "2023", color: "#B22222", instruments: ["二胡", "琵琶", "古筝", "扬琴"]}
            ];
            
            const svg = d3.select("#history-timeline svg");
            const width = svg.node().getBoundingClientRect().width;
            const height = 0; // 增加高度以容纳更复杂的可视化
            
            svg.attr("height", height);
            svg.selectAll("*").remove(); // 清除之前的内容
            
            const margin = {top: 60, right: 100, bottom: 80, left: 100};
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            // 创建主图表容器
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            // 创建径向布局
            const radius = Math.min(innerWidth, innerHeight) / 1.1; // 减小除数以放大整体比例
            const arcGenerator = d3.arc()
                .innerRadius(radius * 0.6) // 增加内圆半径
                .outerRadius(radius * 0.8); // 增加外圆半径
            
            // 创建饼图布局
            const pie = d3.pie()
                .value(d => d.importance)
                .sort(null); // 不排序，保持数据原有顺序
            
            // 设置中心点
            const center = g.append("g")
                .attr("transform", `translate(${innerWidth / 3}, ${innerHeight / 2})`);
            
            // 添加背景圆环
            center.append("circle")
                .attr("r", radius * 0.6)
                .attr("fill", "#2a0845")
                .attr("stroke", "#d4af37")
                .attr("stroke-width", 1);
            
            // 添加中心文字
            center.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "-0.2em")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 16)
                .text("中国弦乐");
            
            center.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "1em")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 16)
                .text("发展历程");
            
            // 创建弧形路径
            const arcs = center.selectAll(".arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc");
            
            // 添加弧形
            arcs.append("path")
                .attr("d", arcGenerator.outerRadius(radius * 0.7)) // 增加弧形半径到原来的1.2倍
                .attr("fill", d => d.data.color)
                .attr("stroke", "#2a0845") 
                .attr("stroke-width", 5)
                .attr("opacity", 2)
                .on("mouseover", function(event, d) {
                    // 高亮当前弧形
                    d3.select(this)
                        .attr("opacity", 1)
                        .attr("stroke-width", 3);
                    
                    // 显示详细信息面板,设置最高层级
                    const infoPanel = svg.append("g")
                        .attr("class", "info-panel")
                        .attr("transform", `translate(${width/2 - 140}, ${margin.top - 70})`) // 水平居中并向上偏移20px,140为面板宽度的一半
                        .raise(); // 确保信息面板显示在最上层
                    infoPanel.append("rect")
                        .attr("width", 1)
                        .attr("height", 160)
                        .attr("rx", 20)
                        .attr("ry", 20)
                        .attr("fill", "rgba(42, 8, 69, 0.9)")
                        .attr("stroke", d.data.color)
                        .attr("stroke-width", 2);
                    
                    infoPanel.append("text")
                        .attr("x", 140)
                        .attr("y", 30)
                        .attr("text-anchor", "middle")
                        .attr("fill", d.data.color)
                        .attr("font-family", "KingHwa_OldSong")
                        .attr("font-size", 18)
                        .text(d.data.year + "时期");
                    
                    infoPanel.append("text")
                        .attr("x", 140)
                        .attr("y", 55)
                        .attr("text-anchor", "middle")
                        .attr("fill", "#d4af37")
                        .attr("font-family", "KingHwa_OldSong")
                        .attr("font-size", 14)
                        .text(`${d.data.startYear} 至 ${d.data.endYear}`);
                    
                    infoPanel.append("text")
                        .attr("x", 140)
                        .attr("y", 80)
                        .attr("text-anchor", "middle")
                        .attr("fill", "#d4af37")
                        .attr("font-family", "KingHwa_OldSong")
                        .attr("font-size", 16)
                        .text(d.data.event);
                    
                    infoPanel.append("text")
                        .attr("x", 15)
                        .attr("y", 105)
                        .attr("fill", "#e6d5b8")
                        .attr("font-family", "KingHwa_OldSong")
                        .attr("font-size", 14)
                        .text("代表乐器：" + d.data.instruments.join("、"));
                    
                    // 使用foreignObject添加详细描述，支持文本换行
                    const fo = infoPanel.append("foreignObject")
                        .attr("x", 15)
                        .attr("y", 115)
                        .attr("width", 250)
                        .attr("height", 80);
                    
                    fo.append("xhtml:div")
                        .style("color", "#e6d5b8")
                        .style("font-family", "KingHwa_OldSong")
                        .style("font-size", "12px")
                        .style("line-height", "1.4")
                        .html(d.data.details);
                    
                    // 添加乐器图标
                    const instrumentIcons = center.append("g")
                        .attr("class", "instrument-icons");
                    
                    d.data.instruments.forEach((inst, i) => {
                        const angle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                        const x = Math.cos(angle) * (radius * 0.85);
                        const y = Math.sin(angle) * (radius * 0.85);
                        
                        instrumentIcons.append("circle")
                            .attr("cx", x + i * 20 - (d.data.instruments.length - 1) * 10)
                            .attr("cy", y)
                            .attr("r", 8)
                            .attr("fill", d.data.color)
                            .attr("stroke", "#2a0845")
                            .attr("stroke-width", 1);
                        
                        instrumentIcons.append("text")
                            .attr("x", x + i * 20 - (d.data.instruments.length - 1) * 10)
                            .attr("y", y)
                            .attr("dy", "0.35em")
                            .attr("text-anchor", "middle")
                            .attr("fill", "#2a0845")
                            .attr("font-family", "KingHwa_OldSong")
                            .attr("font-size", 10)
                            .text(inst.substring(0, 1));
                    });
                })
                .on("mouseout", function() {
                    // 恢复弧形样式
                    d3.select(this)
                        .attr("opacity", 0.8)
                        .attr("stroke-width", 2);
                    
                    // 移除信息面板和乐器图标
                    svg.selectAll(".info-panel").remove();
                    center.selectAll(".instrument-icons").remove();
                });
            
            // 添加连接线和标签
            arcs.append("line")
                .attr("x1", d => {
                    const angle = (d.startAngle + d.endAngle) / 2;
                    return Math.cos(angle) * (radius * 0.7);
                })
                .attr("y1", d => {
                    const angle = (d.startAngle + d.endAngle) / 2;
                    return Math.sin(angle) * (radius * 0.7);
                })
                .attr("x2", d => {
                    const angle = (d.startAngle + d.endAngle) / 2;
                    return Math.cos(angle) * (radius * 0.9);
                })
                .attr("y2", d => {
                    const angle = (d.startAngle + d.endAngle) / 2;
                    return Math.sin(angle) * (radius * 0.9);
                })
                .attr("stroke", d => d.data.color)
                .attr("stroke-width", 2);
            
            arcs.append("text")
                .attr("transform", d => {
                    const angle = (d.startAngle + d.endAngle) / 2;
                    const x = Math.cos(angle) * (radius * 0.95);
                    const y = Math.sin(angle) * (radius * 0.95);
                    return `translate(${x}, ${y})`;
                })
                .attr("text-anchor", d => {
                    const angle = (d.startAngle + d.endAngle) / 2;
                    return Math.cos(angle) > 0 ? "start" : "end";
                })
                .attr("dy", "0.35em")
                .attr("fill", d => d.data.color)
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 14)
                .attr("font-weight", "bold")
                .text(d => d.data.year);
            
            // 添加事件标记
            arcs.append("circle")
                .attr("transform", d => {
                    const angle = (d.startAngle + d.endAngle) / 2;
                    const x = Math.cos(angle) * (radius * 0.5);
                    const y = Math.sin(angle) * (radius * 0.5);
                    return `translate(${x}, ${y})`;
                })
                .attr("r", d => 5 + d.data.importance)
                .attr("fill", d => d.data.color)
                .attr("stroke", "#2a0845")
                .attr("stroke-width", 1.5)
                .attr("opacity", 0.9);
            
            // 添加图例
            const legend = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${height - margin.bottom - 30})`);
            
            data.forEach((d, i) => {
                const legendRow = legend.append("g")
                    .attr("transform", `translate(${i * (innerWidth / data.length)}, 0)`);
                
                legendRow.append("rect")
                    .attr("width", 5)
                    .attr("height", 15)
                    .attr("fill", d.color);
                
                legendRow.append("text")
                    .attr("x", 1)
                    .attr("y", -7)
                    .attr("fill", "#d4af37")
                    .attr("font-family", "KingHwa_OldSong")
                    .attr("font-size", 7)
                    .text(d.year);
            });
            
            // 添加交互提示
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height - 10)  // 将y坐标从height-10改为height-20,使文字上移
                .attr("text-anchor", "middle")
                .attr("fill", "#e6d5b8")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 12)
                .text("鼠标悬停在时间段上可查看详细信息");
        }
        
        function initInstrumentOrigins() {
            const data = [
                {name: "琵琶", origin: "波斯", dynasty: "秦汉", route: "丝绸之路", features: ["梨形音箱", "四弦", "拨奏"]},
                {name: "古琴", origin: "中国", dynasty: "商周", route: "本土发展", features: ["七弦", "面板音箱", "指弹"]},
                {name: "二胡", origin: "中国", dynasty: "唐宋", route: "北方游牧民族", features: ["二弦", "弓奏", "膜面音箱"]},
                {name: "古筝", origin: "中国", dynasty: "战国", route: "本土发展", features: ["21弦", "面板音箱", "拨奏"]},
                {name: "阮咸", origin: "中国", dynasty: "魏晋", route: "本土发展", features: ["圆形音箱", "四弦", "拨奏"]}
            ];
            
            const svg = d3.select("#instrument-origins svg");
            const width = svg.node().getBoundingClientRect().width;
            const height = 0;
            
            svg.attr("height", height);
            
            // 创建地图背景
            const mapGroup = svg.append("g")
                .attr("transform", "translate(0, 20)");
            
            // 简化的丝绸之路路径
            const silkRoadPath = "M50,100 C100,80 150,120 200,100 S250,60 300,80";
            
            mapGroup.append("path")
                .attr("d", silkRoadPath)
                .attr("fill", "none")
                .attr("stroke", "#d4af37")
                .attr("stroke-width", 3)
                .attr("stroke-dasharray", "5,5")
                .attr("opacity", 0.7);
            
            // 添加地点标记
            const locations = [
                {name: "波斯", x: 50, y: 100},
                {name: "西域", x: 150, y: 120},
                {name: "中原", x: 250, y: 60},
                {name: "江南", x: 300, y: 80}
            ];
            
            const locationGroups = mapGroup.selectAll(".location")
                .data(locations)
                .enter()
                .append("g")
                .attr("class", "location")
                .attr("transform", d => `translate(${d.x}, ${d.y})`);
            
            locationGroups.append("circle")
                .attr("r", 8)
                .attr("fill", "#2a0845")
                .attr("stroke", "#d4af37")
                .attr("stroke-width", 2);
            
            locationGroups.append("text")
                .attr("text-anchor", "middle")
                .attr("y", -15)
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .text(d => d.name);
            
            // 添加乐器图标
            const instrumentGroups = svg.append("g")
                .selectAll(".instrument")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "instrument");
            
            // 根据乐器起源位置放置图标
            instrumentGroups.attr("transform", d => {
                let x, y;
                if (d.origin === "波斯") {
                    x = 50;
                    y = 150;
                } else if (d.dynasty === "商周") {
                    x = 250;
                    y = 100;
                } else if (d.dynasty === "秦汉") {
                    x = 200;
                    y = 150;
                } else if (d.dynasty === "魏晋") {
                    x = 250;
                    y = 180;
                } else {
                    x = 300;
                    y = 150;
                }
                return `translate(${x}, ${y})`;
            });
            
            // 添加乐器图标
            instrumentGroups.append("circle")
                .attr("r", 15)
                .attr("fill", d => {
                    if (d.origin === "波斯") return "#DAA520";
                    if (d.dynasty === "商周") return "#8B4513";
                    if (d.dynasty === "秦汉") return "#4B0082";
                    if (d.dynasty === "魏晋") return "#CD5C5C";
                    return "#4682B4";
                })
                .attr("stroke", "#2a0845")
                .attr("stroke-width", 2);
            
            instrumentGroups.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", ".3em")
                .attr("fill", "#e6d5b8")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 10)
                .text(d => d.name.substring(0, 2));
            
            // 添加交互效果
            instrumentGroups.on("mouseover", function(event, d) {
                d3.select(this).select("circle")
                    .attr("r", 20)
                    .attr("fill", "#ff6b6b");
                
                // 添加详细信息提示
                const tooltip = svg.append("g")
                    .attr("class", "origin-tooltip")
                    .attr("transform", () => {
                        const transform = d3.select(this).attr("transform");
                        const match = /translate\((\d+),\s*(\d+)\)/.exec(transform);
                        if (match) {
                            const x = parseInt(match[1]);
                            const y = parseInt(match[2]) - 60;
                            return `translate(${x}, ${y})`;
                        }
                        return "translate(0, 0)";
                    });
                
                tooltip.append("rect")
                    .attr("width", 180)
                    .attr("height", 90)
                    .attr("x", -90)
                    .attr("y", -45)
                    .attr("rx", 5)
                    .attr("ry", 5)
                    .attr("fill", "rgba(42, 8, 69, 0.8)")
                    .attr("stroke", "#d4af37");
                
                tooltip.append("text")
                    .attr("text-anchor", "middle")
                    .attr("y", -25)
                    .attr("fill", "#d4af37")
                    .text(d.name);
                
                tooltip.append("text")
                    .attr("text-anchor", "middle")
                    .attr("y", -5)
                    .attr("fill", "#e6d5b8")
                    .text(`起源: ${d.origin} (${d.dynasty})`);
                
                tooltip.append("text")
                    .attr("text-anchor", "middle")
                    .attr("y", 15)
                    .attr("fill", "#e6d5b8")
                    .text(`传播: ${d.route}`);
                
                tooltip.append("text")
                    .attr("text-anchor", "middle")
                    .attr("y", 35)
                    .attr("fill", "#e6d5b8")
                    .text(`特征: ${d.features.join(", ")}`);
            })
            .on("mouseout", function() {
                d3.select(this).select("circle")
                    .attr("r", 15)
                    .attr("fill", d => {
                        if (d.origin === "波斯") return "#DAA520";
                        if (d.dynasty === "商周") return "#8B4513";
                        if (d.dynasty === "秦汉") return "#4B0082";
                        if (d.dynasty === "魏晋") return "#CD5C5C";
                        return "#4682B4";
                    });
                
                svg.selectAll(".origin-tooltip").remove();
            });
            
            // 添加图例
            const legend = svg.append("g")
                .attr("transform", "translate(20, 250)");
            
            const origins = ["波斯", "商周", "秦汉", "魏晋", "唐宋"];
            const colors = ["#DAA520", "#8B4513", "#4B0082", "#CD5C5C", "#4682B4"];
            
            origins.forEach((origin, i) => {
                const legendItem = legend.append("g")
                    .attr("transform", `translate(${i * 60}, 0)`);
                
                legendItem.append("circle")
                    .attr("r", 6)
                    .attr("fill", colors[i]);
                
                legendItem.append("text")
                    .attr("x", 10)
                    .attr("y", 4)
                    .attr("fill", "#d4af37")
                    .attr("font-family", "KingHwa_OldSong")
                    .attr("font-size", 12)
                    .text(origin);
            });
        }
        
        function initDynastyComparison() {
            const data = [
                {dynasty: "商周", instruments: 2, techniques: 3, repertoire: 5},
                {dynasty: "秦汉", instruments: 4, techniques: 6, repertoire: 8},
                {dynasty: "魏晋", instruments: 5, techniques: 7, repertoire: 10},
                {dynasty: "隋唐", instruments: 8, techniques: 12, repertoire: 15},
                {dynasty: "宋元", instruments: 10, techniques: 15, repertoire: 20},
                {dynasty: "明清", instruments: 12, techniques: 18, repertoire: 25},
                {dynasty: "近代", instruments: 15, techniques: 22, repertoire: 30}
            ];
            
            const svg = d3.select("#dynasty-comparison svg");
            const width = svg.node().getBoundingClientRect().width;
            const height = 400;
            const margin = {top: 60, right: 30, bottom: 60, left: 60};
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            svg.attr("height", height);
            
            // 创建图表容器
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            // 创建X轴比例尺
            const x0 = d3.scaleBand()
                .domain(data.map(d => d.dynasty))
                .range([0, innerWidth])
                .paddingInner(0.1);
            
            const x1 = d3.scaleBand()
                .domain(["instruments", "techniques", "repertoire"])
                .range([0, x0.bandwidth()])
                .padding(0.05);
            
            // 创建Y轴比例尺
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => Math.max(d.instruments, d.techniques, d.repertoire))])
                .nice()
                .range([innerHeight, 0]);
            
            // 创建颜色比例尺
            const color = d3.scaleOrdinal()
                .domain(["instruments", "techniques", "repertoire"])
                .range(["#8B4513", "#4B0082", "#CD5C5C"]);
            
            // 添加X轴
            g.append("g")
                .attr("transform", `translate(0, ${innerHeight})`)
                .call(d3.axisBottom(x0))
                .selectAll("text")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 12);
            
            // 添加Y轴
            g.append("g")
                .call(d3.axisLeft(y))
                .selectAll("text")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 12);
            
            // 添加Y轴标题
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -40)
                .attr("x", -innerHeight / 2)
                .attr("text-anchor", "middle")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 14)
                .text("数量");
            
            // 添加图表标题
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", 30)
                .attr("text-anchor", "middle")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 18)
                .text("各朝代弦乐发展程度");
            
            // 添加图例
            const legend = svg.append("g")
                .attr("transform", `translate(${width - margin.right - 150}, ${margin.top})`);
            
            const categories = [{name: "乐器", key: "instruments"}, {name: "技法", key: "techniques"}, {name: "曲目", key: "repertoire"}];
            
            categories.forEach((category, i) => {
                const legendRow = legend.append("g")
                    .attr("transform", `translate(0, ${i * 20})`);
                
                legendRow.append("rect")
                    .attr("width", 15)
                    .attr("height", 15)
                    .attr("fill", color(category.key));
                
                legendRow.append("text")
                    .attr("x", 20)
                    .attr("y", 12)
                    .attr("fill", "#d4af37")
                    .attr("font-family", "KingHwa_OldSong")
                    .attr("font-size", 12)
                    .text(category.name);
            });
            
            // 添加柱状图
            const dynastyGroups = g.selectAll(".dynasty-group")
                .data(data)
                .enter().append("g")
                .attr("class", "dynasty-group")
                .attr("transform", d => `translate(${x0(d.dynasty)}, 0)`);
            
            // 为每个朝代添加三种类型的柱子
            dynastyGroups.selectAll("rect")
                .data(d => [
                    {key: "instruments", value: d.instruments, dynasty: d.dynasty},
                    {key: "techniques", value: d.techniques, dynasty: d.dynasty},
                    {key: "repertoire", value: d.repertoire, dynasty: d.dynasty}
                ])
                .enter().append("rect")
                .attr("x", d => x1(d.key))
                .attr("y", d => y(d.value))
                .attr("width", x1.bandwidth())
                .attr("height", d => innerHeight - y(d.value))
                .attr("fill", d => color(d.key))
                .attr("stroke", "#2a0845")
                .attr("stroke-width", 1)
                .on("mouseover", function(event, d) {
                    d3.select(this)
                        .attr("fill", "#ff6b6b");
                    
                    // 添加提示框
                    const tooltip = svg.append("g")
                        .attr("class", "dynasty-tooltip")
                        .attr("transform", () => {
                            const xPos = x0(d.dynasty) + x1(d.key) + x1.bandwidth() / 2 + margin.left;
                            const yPos = y(d.value) + margin.top - 40;
                            return `translate(${xPos}, ${yPos})`;
                        });
                    
                    tooltip.append("rect")
                        .attr("width", 120)
                        .attr("height", 60)
                        .attr("x", -60)
                        .attr("y", -30)
                        .attr("rx", 5)
                        .attr("ry", 5)
                        .attr("fill", "rgba(42, 8, 69, 0.9)")
                        .attr("stroke", "#d4af37");
                    
                    tooltip.append("text")
                        .attr("text-anchor", "middle")
                        .attr("y", -10)
                        .attr("fill", "#d4af37")
                        .attr("font-family", "KingHwa_OldSong")
                        .attr("font-size", 14)
                        .text(d.dynasty);
                    
                    let categoryName = "";
                    if (d.key === "instruments") categoryName = "乐器数量";
                    else if (d.key === "techniques") categoryName = "技法数量";
                    else if (d.key === "repertoire") categoryName = "曲目数量";
                    
                    tooltip.append("text")
                        .attr("text-anchor", "middle")
                        .attr("y", 10)
                        .attr("fill", "#e6d5b8")
                        .attr("font-family", "KingHwa_OldSong")
                        .attr("font-size", 12)
                        .text(`${categoryName}: ${d.value}`);
                })
                .on("mouseout", function() {
                    d3.select(this)
                        .attr("fill", d => color(d.key));
                    
                    svg.selectAll(".dynasty-tooltip").remove();
                });
        }
        
        function initHistoricalEvents() {
            const data = [
                {year: -1046, event: "周礼确立礼乐制度", impact: 8},
                {year: -221, event: "秦汉统一促进乐器交流", impact: 7},
                {year: 618, event: "唐代设立教坊", impact: 9},
                {year: 960, event: "宋代市民音乐兴起", impact: 8},
                {year: 1368, event: "明代戏曲发展", impact: 7},
                {year: 1912, event: "民国时期国乐改进", impact: 6}
            ];
            
            const svg = d3.select("#historical-events svg");
            const width = svg.node().getBoundingClientRect().width;
            const height = 300;
            const margin = {top: 60, right: 30, bottom: 60, left: 60};
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            svg.attr("height", height);
            
            // 创建图表容器
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            // 创建X轴比例尺（时间轴）
            const x = d3.scaleLinear()
                .domain([d3.min(data, d => d.year) - 100, d3.max(data, d => d.year) + 100])
                .range([0, innerWidth]);
            
            // 创建Y轴比例尺（影响程度）
            const y = d3.scaleLinear()
                .domain([0, 10])
                .range([innerHeight, 0]);
            
            // 创建半径比例尺（影响程度）
            const radius = d3.scaleLinear()
                .domain([d3.min(data, d => d.impact), d3.max(data, d => d.impact)])
                .range([8, 15]);
            
            // 添加X轴
            g.append("g")
                .attr("transform", `translate(0, ${innerHeight})`)
                .call(d3.axisBottom(x)
                    .tickFormat(d => {
                        if (d < 0) return `公元前${Math.abs(d)}`;
                        return `公元${d}`;
                    })
                    .ticks(6))
                .selectAll("text")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 12)
                .attr("transform", "rotate(-30)")
                .attr("text-anchor", "end");
            
            // 添加X轴标题
            g.append("text")
                .attr("x", innerWidth / 2)
                .attr("y", innerHeight + 50)
                .attr("text-anchor", "middle")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 14)
                .text("历史年代");
            
            // 添加图表标题
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", 30)
                .attr("text-anchor", "middle")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 18)
                .text("中国弦乐重要历史事件");
            
            // 添加时间线
            g.append("line")
                .attr("x1", 0)
                .attr("y1", innerHeight / 2)
                .attr("x2", innerWidth)
                .attr("y2", innerHeight / 2)
                .attr("stroke", "#d4af37")
                .attr("stroke-width", 2)
                .attr("stroke-dasharray", "5,5");
            
            // 添加事件点
            const events = g.selectAll(".event")
                .data(data)
                .enter().append("g")
                .attr("class", "event")
                .attr("transform", d => `translate(${x(d.year)}, ${innerHeight / 2})`);
            
            // 添加事件圆点
            events.append("circle")
                .attr("r", d => radius(d.impact))
                .attr("fill", d => {
                    // 根据时代分配不同颜色
                    if (d.year < 0) return "#8B4513"; // 古代
                    if (d.year < 1000) return "#4B0082"; // 中古
                    if (d.year < 1800) return "#CD5C5C"; // 近古
                    return "#4682B4"; // 近现代
                })
                .attr("stroke", "#2a0845")
                .attr("stroke-width", 2);
            
            // 添加事件连接线
            events.append("line")
                .attr("x1", 0)
                .attr("y1", 0)
                .attr("x2", 0)
                .attr("y2", d => d.year % 2 === 0 ? -50 : 50) // 交错显示
                .attr("stroke", "#d4af37")
                .attr("stroke-width", 1);
            
            // 添加事件文本
            events.append("text")
                .attr("x", 0)
                .attr("y", d => d.year % 2 === 0 ? -60 : 60)
                .attr("text-anchor", "middle")
                .attr("fill", "#e6d5b8")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 12)
                .text(d => d.event);
            
            // 添加年份文本
            events.append("text")
                .attr("x", 0)
                .attr("y", d => d.year % 2 === 0 ? -75 : 75)
                .attr("text-anchor", "middle")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 10)
                .text(d => {
                    if (d.year < 0) return `公元前${Math.abs(d.year)}`;
                    return `公元${d.year}`;
                });
            
            // 添加交互效果
            events.on("mouseover", function(event, d) {
                d3.select(this).select("circle")
                    .attr("r", radius(d.impact) * 1.5)
                    .attr("fill", "#ff6b6b");
                
                // 添加提示框
                const tooltip = g.append("g")
                    .attr("class", "event-tooltip")
                    .attr("transform", `translate(${x(d.year)}, ${innerHeight / 2 - 80})`);
                
                tooltip.append("rect")
                    .attr("width", 160)
                    .attr("height", 60)
                    .attr("x", -80)
                    .attr("y", -30)
                    .attr("rx", 5)
                    .attr("ry", 5)
                    .attr("fill", "rgba(42, 8, 69, 0.9)")
                    .attr("stroke", "#d4af37");
                
                tooltip.append("text")
                    .attr("text-anchor", "middle")
                    .attr("y", -10)
                    .attr("fill", "#d4af37")
                    .attr("font-family", "KingHwa_OldSong")
                    .attr("font-size", 14)
                    .text(d.event);
                
                tooltip.append("text")
                    .attr("text-anchor", "middle")
                    .attr("y", 10)
                    .attr("fill", "#e6d5b8")
                    .attr("font-family", "KingHwa_OldSong")
                    .attr("font-size", 12)
                    .text(`年代: ${d.year < 0 ? `公元前${Math.abs(d.year)}` : `公元${d.year}`}`);
                
                tooltip.append("text")
                    .attr("text-anchor", "middle")
                    .attr("y", 30)
                    .attr("fill", "#e6d5b8")
                    .attr("font-family", "KingHwa_OldSong")
                    .attr("font-size", 12)
                    .text(`影响程度: ${d.impact}/10`);
            })
            .on("mouseout", function(event, d) {
                d3.select(this).select("circle")
                    .attr("r", radius(d.impact))
                    .attr("fill", d => {
                        if (d.year < 0) return "#8B4513";
                        if (d.year < 1000) return "#4B0082";
                        if (d.year < 1800) return "#CD5C5C";
                        return "#4682B4";
                    });
                
                g.selectAll(".event-tooltip").remove();
            });
        }
        
        // function initTechniqueEvolution() - 已删除
        
        function initMaterialChanges() {
            const data = [
                {period: "古代", materials: ["桐木", "丝弦", "竹码"], durability: 5, tone: 7},
                {period: "中古", materials: ["紫檀", "丝弦", "骨码"], durability: 6, tone: 8},
                {period: "近古", materials: ["红木", "钢弦", "骨码"], durability: 7, tone: 8},
                {period: "现代", materials: ["复合材料", "尼龙弦", "塑料码"], durability: 9, tone: 6}
            ];
            
            const svg = d3.select("#material-changes svg");
            const width = svg.node().getBoundingClientRect().width;
            const height = 500;
            
            svg.attr("height", height);
            
            // 创建两个可视化区域
            const materialChartHeight = 250;
            const radarChartHeight = 250;
            
            // 材料变迁图表
            const materialChart = svg.append("g")
                .attr("transform", `translate(0, 0)`);
            
            // 雷达图
            const radarChart = svg.append("g")
                .attr("transform", `translate(${width/2}, ${materialChartHeight + 120})`);
            
            // 添加标题
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", 30)
                .attr("text-anchor", "middle")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 18)
                .text("弦乐器材料变迁");
            
            // 1. 材料变迁堆叠条形图
            const margin = {top: 60, right: 30, bottom: 40, left: 60};
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = materialChartHeight - margin.top - margin.bottom;
            
            const materialG = materialChart.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            // 创建X轴比例尺
            const x = d3.scaleBand()
                .domain(data.map(d => d.period))
                .range([0, innerWidth])
                .padding(0.3);
            
            // 创建Y轴比例尺
            const y = d3.scaleLinear()
                .domain([0, 3]) // 每个时期有3种材料
                .range([innerHeight, 0]);
            
            // 添加X轴
            materialG.append("g")
                .attr("transform", `translate(0, ${innerHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 12);
            
            // 添加Y轴标题
            materialG.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -40)
                .attr("x", -innerHeight / 2)
                .attr("text-anchor", "middle")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 14)
                .text("材料类型");
            
            // 创建颜色比例尺
            const materialTypes = ["琴身", "琴弦", "琴码"];
            const color = d3.scaleOrdinal()
                .domain(materialTypes)
                .range(["#8B4513", "#4B0082", "#CD5C5C"]);
            
            // 添加材料条形图
            data.forEach((d, i) => {
                const periodG = materialG.append("g")
                    .attr("transform", `translate(${x(d.period)}, 0)`);
                
                d.materials.forEach((material, j) => {
                    const rect = periodG.append("rect")
                        .attr("x", 0)
                        .attr("y", y(j + 1))
                        .attr("width", x.bandwidth())
                        .attr("height", innerHeight / 3)
                        .attr("fill", color(materialTypes[j]))
                        .attr("stroke", "#2a0845")
                        .attr("stroke-width", 1);
                    
                    // 添加材料文本
                    periodG.append("text")
                        .attr("x", x.bandwidth() / 2)
                        .attr("y", y(j + 0.5))
                        .attr("text-anchor", "middle")
                        .attr("fill", "#e6d5b8")
                        .attr("font-family", "KingHwa_OldSong")
                        .attr("font-size", 12)
                        .text(material);
                    
                    // 添加交互效果
                    rect.on("mouseover", function(event) {
                        d3.select(this)
                            .attr("fill", "#ff6b6b");
                        
                        // 添加提示框
                        const tooltip = materialG.append("g")
                            .attr("class", "material-tooltip")
                            .attr("transform", `translate(${x(d.period) + x.bandwidth() / 2}, ${y(j + 1) - 20})`);
                        
                        tooltip.append("rect")
                            .attr("width", 140)
                            .attr("height", 60)
                            .attr("x", -70)
                            .attr("y", -30)
                            .attr("rx", 5)
                            .attr("ry", 5)
                            .attr("fill", "rgba(42, 8, 69, 0.9)")
                            .attr("stroke", "#d4af37");
                        
                        tooltip.append("text")
                            .attr("text-anchor", "middle")
                            .attr("y", -10)
                            .attr("fill", "#d4af37")
                            .attr("font-family", "KingHwa_OldSong")
                            .attr("font-size", 14)
                            .text(`${d.period}时期`);
                        
                        tooltip.append("text")
                            .attr("text-anchor", "middle")
                            .attr("y", 10)
                            .attr("fill", "#e6d5b8")
                            .attr("font-family", "KingHwa_OldSong")
                            .attr("font-size", 12)
                            .text(`${materialTypes[j]}: ${material}`);
                    })
                    .on("mouseout", function() {
                        d3.select(this)
                            .attr("fill", color(materialTypes[j]));
                        
                        materialG.selectAll(".material-tooltip").remove();
                    });
                });
            });
            
            // 添加图例
            const legend = materialChart.append("g")
                .attr("transform", `translate(${width - margin.right - 100}, ${margin.top})`);
            
            materialTypes.forEach((type, i) => {
                const legendRow = legend.append("g")
                    .attr("transform", `translate(0, ${i * 20})`);
                
                legendRow.append("rect")
                    .attr("width", 15)
                    .attr("height", 15)
                    .attr("fill", color(type));
                
                legendRow.append("text")
                    .attr("x", 20)
                    .attr("y", 12)
                    .attr("fill", "#d4af37")
                    .attr("font-family", "KingHwa_OldSong")
                    .attr("font-size", 12)
                    .text(type);
            });
            
            // 2. 雷达图 - 展示耐久度和音色
            // 添加雷达图标题
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", materialChartHeight + 60)
                .attr("text-anchor", "middle")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 16)
                .text("材料性能对比");
            
            // 雷达图配置
            const radarRadius = 100;
            const radarFeatures = ["耐久度", "音色"];
            const radarAngle = d3.scaleLinear()
                .domain([0, radarFeatures.length])
                .range([0, 2 * Math.PI]);
            
            const radarRadiusScale = d3.scaleLinear()
                .domain([0, 10])
                .range([0, radarRadius]);
            
            // 创建雷达图轴
            const radarAxes = radarChart.selectAll(".radar-axis")
                .data(radarFeatures)
                .enter().append("g")
                .attr("class", "radar-axis");
            
            // 添加雷达图轴线
            radarAxes.append("line")
                .attr("x1", 0)
                .attr("y1", 0)
                .attr("x2", (d, i) => radarRadius * Math.cos(radarAngle(i) - Math.PI / 2))
                .attr("y2", (d, i) => radarRadius * Math.sin(radarAngle(i) - Math.PI / 2))
                .attr("stroke", "#d4af37")
                .attr("stroke-width", 1);
            
            // 添加雷达图轴标签
            radarAxes.append("text")
                .attr("x", (d, i) => (radarRadius + 20) * Math.cos(radarAngle(i) - Math.PI / 2))
                .attr("y", (d, i) => (radarRadius + 20) * Math.sin(radarAngle(i) - Math.PI / 2))
                .attr("text-anchor", "middle")
                .attr("fill", "#d4af37")
                .attr("font-family", "KingHwa_OldSong")
                .attr("font-size", 14)
                .text(d => d);
            
            // 添加雷达图同心圆
            const radarCircles = [2, 4, 6, 8, 10];
            radarChart.selectAll(".radar-circle")
                .data(radarCircles)
                .enter().append("circle")
                .attr("class", "radar-circle")
                .attr("cx", 0)
                .attr("cy", 0)
                .attr("r", d => radarRadiusScale(d))
                .attr("fill", "none")
                .attr("stroke", "#d4af37")
                .attr("stroke-width", 0.5)
                .attr("stroke-dasharray", "2,2");
            
            // 添加雷达图数据多边形
            const radarColor = d3.scaleOrdinal()
                .domain(data.map(d => d.period))
                .range(["#8B4513", "#4B0082", "#CD5C5C", "#4682B4"]);
            
            data.forEach(d => {
                // 计算雷达图顶点
                const radarPoints = [
                    [radarRadiusScale(d.durability) * Math.cos(radarAngle(0) - Math.PI / 2), radarRadiusScale(d.durability) * Math.sin(radarAngle(0) - Math.PI / 2)],
                    [radarRadiusScale(d.tone) * Math.cos(radarAngle(1) - Math.PI / 2), radarRadiusScale(d.tone) * Math.sin(radarAngle(1) - Math.PI / 2)]
                ];
                
                // 创建雷达图路径
                const radarLine = d3.line()
                    .x(p => p[0])
                    .y(p => p[1])
                    .curve(d3.curveLinearClosed);
                
                // 添加雷达图多边形
                radarChart.append("path")
                    .datum(radarPoints)
                    .attr("d", radarLine)
                    .attr("fill", radarColor(d.period))
                    .attr("fill-opacity", 0.3)
                    .attr("stroke", radarColor(d.period))
                    .attr("stroke-width", 2);
                
                // 添加雷达图顶点
                radarChart.selectAll(".radar-point-" + d.period)
                    .data(radarPoints)
                    .enter().append("circle")
                    .attr("class", "radar-point-" + d.period)
                    .attr("cx", p => p[0])
                    .attr("cy", p => p[1])
                    .attr("r", 4)
                    .attr("fill", radarColor(d.period));
            });
            
            // 添加雷达图图例
            const radarLegend = svg.append("g")
                .attr("transform", `translate(${width - 100}, ${materialChartHeight + 80})`);
            
            data.forEach((d, i) => {
                const legendRow = radarLegend.append("g")
                    .attr("transform", `translate(0, ${i * 20})`);
                
                legendRow.append("rect")
                    .attr("width", 15)
                    .attr("height", 15)
                    .attr("fill", radarColor(d.period));
                
                legendRow.append("text")
                    .attr("x", 20)
                    .attr("y", 12)
                    .attr("fill", "#d4af37")
                    .attr("font-family", "KingHwa_OldSong")
                    .attr("font-size", 12)
                    .text(d.period);
            });
        }
        
        function initSankeyDiagram() {
            const data = {
                nodes: [
                    {name: "商周", category: "朝代"}, {name: "秦汉", category: "朝代"}, {name: "魏晋", category: "朝代"}, 
                    {name: "隋唐", category: "朝代"}, {name: "宋元", category: "朝代"}, {name: "明清", category: "朝代"},
                    {name: "琵琶", category: "乐器"}, {name: "古筝", category: "乐器"}, {name: "二胡", category: "乐器"}, 
                    {name: "阮", category: "乐器"}, {name: "三弦", category: "乐器"}
                ],
                links: [
                    {source: 0, target: 6, value: 3, description: "商周时期琵琶雏形出现"}, 
                    {source: 1, target: 6, value: 5, description: "秦汉时期琵琶传入中原并发展"}, 
                    {source: 2, target: 7, value: 4, description: "魏晋时期古筝开始流行"}, 
                    {source: 3, target: 7, value: 8, description: "隋唐时期古筝达到鼎盛"}, 
                    {source: 4, target: 8, value: 6, description: "宋元时期二胡广泛传播"}, 
                    {source: 5, target: 8, value: 7, description: "明清时期二胡技法成熟"}, 
                    {source: 3, target: 9, value: 5, description: "隋唐时期阮得到发展"}, 
                    {source: 4, target: 10, value: 4, description: "宋元时期三弦开始流行"}
                ]
            };
            
            // 创建SVG容器
// 删除sankey-diagram相关代码
            const width = 800, height = 500;
            const margin = {top: 20, right: 20, bottom: 20, left: 20};
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            // 清空SVG内容
            svg.selectAll("*").remove();
            
            // 设置SVG尺寸
            svg.attr("width", width)
               .attr("height", height);
            
            // 创建图表容器
            const chart = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            // 创建桑基图布局
            const sankey = d3.sankey()
                .nodeWidth(36)
                .nodePadding(40)
                .size([innerWidth, innerHeight]);
                
            // 计算节点和连接的位置
            const {nodes, links} = sankey({
                nodes: data.nodes.map(d => Object.assign({}, d)),
                links: data.links.map(d => Object.assign({}, d))
            });
            
            // 定义颜色比例尺
            const colorScale = d3.scaleOrdinal()
                .domain(["朝代", "乐器"])
                .range(["#5470c6", "#91cc75"]);
                
            // 添加连接
            const link = chart.append("g")
                .attr("class", "links")
                .attr("fill", "none")
                .attr("stroke-opacity", 0.4)
                .selectAll("path")
                .data(links)
                .enter().append("path")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke", d => "#aaa")
                .attr("stroke-width", d => Math.max(1, d.width))
                .style("cursor", "pointer");
            
            // 添加连接的悬停效果和提示信息
            link.append("title")
                .text(d => `${d.source.name} → ${d.target.name}\n流量: ${d.value}\n${d.description}`);
                
            // 添加连接的交互效果
            link.on("mouseover", function() {
                d3.select(this)
                    .attr("stroke-opacity", 0.8)
                    .attr("stroke", "#ff7f0e");
            })
            .on("mouseout", function() {
                d3.select(this)
                    .attr("stroke-opacity", 0.4)
                    .attr("stroke", "#aaa");
            });
            
            // 添加节点
            const node = chart.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(nodes)
                .enter().append("g")
                .style("cursor", "pointer");
                
            // 添加节点矩形
            node.append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0)
                .attr("width", d => d.x1 - d.x0)
                .attr("fill", d => colorScale(d.category))
                .attr("stroke", "#000");
                
            // 添加节点的悬停效果和提示信息
            node.append("title")
                .text(d => `${d.name}\n类别: ${d.category}`);
                
            // 添加节点的交互效果
            node.on("mouseover", function(event, d) {
                // 高亮当前节点
                d3.select(this).select("rect")
                    .attr("fill", d => d3.color(colorScale(d.category)).brighter(0.5));
                    
                // 高亮相关连接
                link.filter(l => l.source === d || l.target === d)
                    .attr("stroke-opacity", 0.8)
                    .attr("stroke", "#ff7f0e");
            })
            .on("mouseout", function(event, d) {
                // 恢复节点颜色
                d3.select(this).select("rect")
                    .attr("fill", d => colorScale(d.category));
                    
                // 恢复连接颜色
                link.filter(l => l.source === d || l.target === d)
                    .attr("stroke-opacity", 0.4)
                    .attr("stroke", "#aaa");
            });
            
            // 添加节点文本
            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .text(d => d.name)
                .attr("font-size", "12px")
                .attr("fill", "#333");
                
            // 添加图例
            const legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${width - 150}, 20)`);
                
            const categories = ["朝代", "乐器"];
            
            categories.forEach((category, i) => {
                const legendRow = legend.append("g")
                    .attr("transform", `translate(0, ${i * 20})`);
                    
                legendRow.append("rect")
                    .attr("width", 15)
                    .attr("height", 15)
                    .attr("fill", colorScale(category));
                    
                legendRow.append("text")
                    .attr("x", 20)
                    .attr("y", 12)
                    .text(category)
                    .attr("font-size", "12px");
            });
            
            // 添加标题
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", 15)
                .attr("text-anchor", "middle")
                .attr("font-size", "16px")
                .attr("font-weight", "bold")
                .text("中国弦乐器历史发展关系图");
        }
        
        function initBubbleChart() {
            const data = [
                {name: "琵琶", period: "隋唐", popularity: 8, size: 30, color: "#d4af37"},
                {name: "古筝", period: "战国", popularity: 7, size: 25, color: "#a67c52"},
                {name: "二胡", period: "唐宋", popularity: 9, size: 35, color: "#8b4513"},
                {name: "阮", period: "魏晋", popularity: 6, size: 15, color: "#cd7f32"},
                {name: "三弦", period: "宋元", popularity: 5, size: 10, color: "#b87333"}
            ];
            
            const svg = d3.select("#bubble-chart svg");
            const width = 600, height = 400;
            
            svg.attr("width", width)
               .attr("height", height);
               
            const x = d3.scaleLinear()
                .domain([0, 10])
                .range([50, width - 50]);
                
            const y = d3.scaleLinear()
                .domain([0, 10])
                .range([height - 50, 50]);
                
            const size = d3.scaleSqrt()
                .domain([0, 10])
                .range([5, 35]);
                
            svg.selectAll("circle")
                .data(data)
                .join("circle")
                .attr("cx", d => x(d.popularity))
                .attr("cy", d => y(d.popularity))
                .attr("r", d => size(d.size))
                .attr("fill", d => d.color)
                .attr("stroke", "#000")
                .attr("stroke-width", 1)
                .append("title")
                .text(d => `${d.name}\n朝代: ${d.period}\n流行度: ${d.popularity}`);
        }
        
        function initForceDirectedGraph() {
            const data = {
                nodes: [
                    {id: "琵琶", group: 1, size: 15},
                    {id: "古筝", group: 1, size: 12},
                    {id: "二胡", group: 2, size: 10},
                    {id: "阮", group: 1, size: 8},
                    {id: "三弦", group: 1, size: 6},
                    {id: "轮指", group: 3, size: 5},
                    {id: "泛音", group: 3, size: 5},
                    {id: "滑音", group: 3, size: 5}
                ],
                links: [
                    {source: "琵琶", target: "轮指", value: 5},
                    {source: "琵琶", target: "泛音", value: 3},
                    {source: "古筝", target: "泛音", value: 4},
                    {source: "二胡", target: "滑音", value: 6},
                    {source: "阮", target: "轮指", value: 2}
                ]
            };
            
            const svg = d3.select("#force-graph svg");
            const width = 600, height = 400;
            
            svg.attr("width", width)
               .attr("height", height);
               
            const simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));
                
            const link = svg.append("g")
                .selectAll("line")
                .data(data.links)
                .join("line")
                .attr("stroke", "#999")
                .attr("stroke-width", d => Math.sqrt(d.value));
                
            const node = svg.append("g")
                .selectAll("circle")
                .data(data.nodes)
                .join("circle")
                .attr("r", d => d.size)
                .attr("fill", d => d.group === 1 ? "#d4af37" : d.group === 2 ? "#a67c52" : "#8b4513")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));
                    
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
            });
        }
        
        function initRadarChart() {
            const data = [
                {instrument: "琵琶", technique: 8, tone: 7, difficulty: 9, popularity: 8},
                {instrument: "古筝", technique: 7, tone: 8, difficulty: 7, popularity: 7},
                {instrument: "二胡", technique: 9, tone: 6, difficulty: 8, popularity: 9},
                {instrument: "阮", technique: 6, tone: 7, difficulty: 6, popularity: 5},
                {instrument: "三弦", technique: 5, tone: 6, difficulty: 7, popularity: 4}
            ];
            
            const svg = d3.select("#radar-chart svg");
            const width = 600, height = 400;
            const radius = Math.min(width, height) / 2;
            
            svg.attr("width", width)
               .attr("height", height)
               .append("g")
               .attr("transform", `translate(${width/2},${height/2})`);
               
            const axes = ["technique", "tone", "difficulty", "popularity"];
            const maxValues = {
                technique: 10, tone: 10, difficulty: 10, popularity: 10
            };
            
            const radarChart = d3.radialLine()
                .angle((d, i) => i * 2 * Math.PI / axes.length)
                .radius(d => radius * d.value / maxValues[d.axis]);
                
            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.instrument))
                .range(["#d4af37", "#a67c52", "#8b4513", "#cd7f32", "#b87333"]);
                
            axes.forEach((axis, i) => {
                const angle = i * 2 * Math.PI / axes.length;
                svg.append("line")
                    .attr("x1", width/2)
                    .attr("y1", height/2)
                    .attr("x2", width/2 + radius * Math.sin(angle))
                    .attr("y2", height/2 - radius * Math.cos(angle))
                    .attr("stroke", "#999")
                    .attr("stroke-width", 1);
                
                svg.append("text")
                    .attr("x", width/2 + (radius + 10) * Math.sin(angle))
                    .attr("y", height/2 - (radius + 10) * Math.cos(angle))
                    .text(axis)
                    .style("font-size", "12px");
            });
            
            data.forEach(d => {
                const points = axes.map(axis => ({
                    axis: axis,
                    value: d[axis]
                }));
                
                svg.append("path")
                    .datum(points)
                    .attr("d", radarChart)
                    .attr("fill", color(d.instrument))
                    .attr("fill-opacity", 0.3)
                    .attr("stroke", color(d.instrument))
                    .attr("stroke-width", 2);
            });
        }
        
        function initChordDiagram() {
            const matrix = [
                [0, 5, 3, 2, 1],  // 琵琶
                [5, 0, 4, 3, 2],  // 古筝
                [3, 4, 0, 1, 1],  // 二胡
                [2, 3, 1, 0, 1],  // 阮
                [1, 2, 1, 1, 0]   // 三弦
            ];
            
            const instruments = ["琵琶", "古筝", "二胡", "阮", "三弦"];
            
            const svg = d3.select("#chord-diagram svg");
            const width = 600, height = 600;
            const outerRadius = Math.min(width, height) * 0.5 - 40;
            const innerRadius = outerRadius - 30;
            
            svg.attr("width", width)
               .attr("height", height)
               .append("g")
               .attr("transform", `translate(${width/2},${height/2})`);
               
            const chord = d3.chord()
                .padAngle(0.05)
                .sortSubgroups(d3.descending);
                
            const arc = d3.arc()
                .innerRadius(innerRadius)
                .outerRadius(outerRadius);
                
            const ribbon = d3.ribbon()
                .radius(innerRadius);
                
            const color = d3.scaleOrdinal()
                .domain(d3.range(instruments.length))
                .range(["#d4af37", "#a67c52", "#8b4513", "#cd7f32", "#b87333"]);
                
            const chords = chord(matrix);
            
            svg.append("g")
                .selectAll("g")
                .data(chords.groups)
                .join("g")
                .append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.index))
                .attr("stroke", "#000");
                
            svg.append("g")
                .selectAll("path")
                .data(chords)
                .join("path")
                .attr("d", ribbon)
                .attr("fill", d => color(d.source.index))
                .attr("stroke", "#000")
                .attr("opacity", 0.7);
                
            svg.append("g")
                .selectAll("g")
                .data(chords.groups)
                .join("g")
                .append("text")
                .each(d => {
                    d.angle = (d.startAngle + d.endAngle) / 2;
                })
                .attr("dy", ".35em")
                .attr("transform", d => `
                    rotate(${d.angle * 180 / Math.PI - 90})
                    translate(${innerRadius + 26})
                    ${d.angle > Math.PI ? "rotate(180)" : ""}
                `)
                .attr("text-anchor", d => d.angle > Math.PI ? "end" : null)
                .text(d => instruments[d.index]);
        }
        
        function initClassificationVis() {
            const classificationData = { 
                name: "中国弦乐", 
                children: [ 
                    { 
                        name: "弹拨类", 
                        children: [ 
                            {name: "琵琶", value: 30}, 
                            {name: "古筝", value: 25}, 
                            {name: "阮", value: 15}, 
                            {name: "三弦", value: 10}, 
                            {name: "月琴", value: 8}, 
                            {name: "柳琴", value: 7}, 
                            {name: "其他", value: 5} 
                        ] 
                    }, 
                    { 
                        name: "拉弦类", 
                        children: [ 
                            {name: "二胡", value: 35}, 
                            {name: "高胡", value: 12}, 
                            {name: "中胡", value: 10}, 
                            {name: "板胡", value: 8}, 
                            {name: "京胡", value: 7}, 
                            {name: "其他", value: 8} 
                        ] 
                    }, 
                    { 
                        name: "击弦类", 
                        children: [ 
                            {name: "扬琴", value: 20}, 
                            {name: "筑", value: 5} 
                        ] 
                    } 
                ] 
            }; 
            
            const classificationSvg = d3.select("#classification-vis") 
                .append("svg") 
                .attr("width", "100%") 
                .attr("height", "300"); 
            
            const classificationG = classificationSvg.append("g") 
                .attr("transform", "translate(150, 150)"); 
            
            const radius = Math.min(classificationSvg.node().getBoundingClientRect().width, 300) / 2 - 10; 
            
            const partition = d3.partition() 
                .size([2 * Math.PI, radius]); 
            
            const root = d3.hierarchy(classificationData) 
                .sum(d => d.value || 0); 
            
            partition(root); 
            
            const arc = d3.arc() 
                .startAngle(d => d.x0) 
                .endAngle(d => d.x1) 
                .innerRadius(d => d.y0) 
                .outerRadius(d => d.y1); 
            
            classificationG.selectAll("path") 
                .data(root.descendants()) 
                .enter() 
                .append("path") 
                .attr("d", arc) 
                .attr("fill", (d, i) => { 
                    const hue = i * 30 % 360; 
                    return `hsla(${hue}, 70%, 50%, 0.6)`; 
                }) 
                .attr("stroke", "#2a0845") 
                .attr("stroke-width", 1) 
                .on("mouseover", function(event, d) { 
                    d3.select(this).attr("fill", "rgba(212, 175, 55, 0.8)"); 
                    
                    classificationG.append("text") 
                        .attr("class", "tooltip") 
                        .attr("x", 0) 
                        .attr("y", -radius - 10) 
                        .attr("text-anchor", "middle") 
                        .text(`${d.data.name}: ${d.value || ""}`) 
                        .attr("fill", "#e6d5b8"); 
                }) 
                .on("mouseout", function() { 
                    d3.select(this).attr("fill", (d, i) => { 
                        const hue = i * 30 % 360; 
                        return `hsla(${hue}, 70%, 50%, 0.6)`; 
                    }); 
                    
                    classificationG.selectAll(".tooltip").remove(); 
                });
        }
        
        function initDynastyDistribution() {
            const data = [
                {dynasty: "商周", instruments: ["琴", "瑟"], development: 3, symbol: "𝄞"},
                {dynasty: "秦汉", instruments: ["琵琶", "阮"], development: 5, symbol: "𝄢"},
                {dynasty: "魏晋", instruments: ["阮咸", "古琴"], development: 4, symbol: "𝄡"},
                {dynasty: "隋唐", instruments: ["琵琶", "古筝", "阮咸"], development: 8, symbol: "𝄠"},
                {dynasty: "宋元", instruments: ["三弦", "古琴", "琵琶"], development: 6, symbol: "𝄟"},
                {dynasty: "明清", instruments: ["二胡", "京胡", "琵琶", "古筝"], development: 7, symbol: "𝄤"},
                {dynasty: "近代", instruments: ["二胡", "琵琶", "古筝", "扬琴"], development: 6, symbol: "𝄥"}
            ];
            
            const svg = d3.select("#dynasty-distribution svg");
            const width = svg.node().getBoundingClientRect().width;
            const height = 0;
            const margin = {top: 20, right: 20, bottom: 30, left: 40};
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            svg.attr("height", height);
            
            // 创建主图层
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            const x = d3.scaleBand()
                .domain(data.map(d => d.dynasty))
                .range([0, innerWidth])
                .padding(0.2);
            
            const y = d3.scaleLinear()
                .domain([0, 10])
                .range([innerHeight, 0]);
            
            // 添加图例
            const legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${width - 120}, 10)`);
            
            
            legend.append("text")
                .attr("x", 55)
                .attr("y", 20)
                .attr("text-anchor", "middle")
                .attr("fill", "#d4af37")
                .style("font-family", "KingHwa_OldSong")
                .text("符号大小表示");
            
            legend.append("text")
                .attr("x", 55)
                .attr("y", 40)
                .attr("text-anchor", "middle")
                .attr("fill", "#d4af37")
                .style("font-family", "KingHwa_OldSong")
                .text("发展程度");
            
            // 添加弦乐符号散点
            g.selectAll(".symbol")
                .data(data)
                .enter()
                .append("text")
                .attr("class", "symbol")
                .attr("x", d => x(d.dynasty) + x.bandwidth()/2)
                .attr("y", d => y(d.development))
                .attr("text-anchor", "middle")
                .attr("dominant-baseline", "middle")
                .attr("font-size", d => 20 + d.development * 3)
                .attr("fill", "#d4af37")
                .text(d => d.symbol)
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("fill", "#ff6b6b");
                    
                    // 显示详细工具提示
                    const tooltip = g.append("g")
                        .attr("class", "dynasty-tooltip")
                        .attr("transform", `translate(${x(d.dynasty) + x.bandwidth() / 2},${y(d.development) - 40})`);
                    tooltip.append("rect")
                        .attr("width", 1)
                        .attr("height", 30)
                        .attr("x", -75)
                        .attr("rx", 5)
                        .attr("ry", 5)
                        .attr("fill", "rgba(0,0,0,0.8)")
                        .attr("stroke", "#d4af37");
                    
                    tooltip.append("text")
                        .attr("text-anchor", "middle")
                        .attr("fill", "#d4af37")
                        .attr("y", -15)
                        .attr("font-family", "KingHwa_OldSong")
                        .text(d.dynasty);
                    
                    tooltip.append("text")
                        .attr("text-anchor", "middle")
                        .attr("fill", "white")
                        .attr("y", 5)
                        .attr("font-family", "KingHwa_OldSong")
                        .text(`乐器: ${d.instruments.join(", ")}`);
                    
                    tooltip.append("text")
                        .attr("text-anchor", "middle")
                        .attr("fill", "white")
                        .attr("y", 25)
                        .attr("font-family", "KingHwa_OldSong")
                        .text(`发展程度: ${d.development}/10`);
                })
                .on("mouseout", function() {
                    d3.select(this).attr("fill", "#d4af37");
                    g.selectAll(".dynasty-tooltip").remove();
                });
            
            // 添加朝代标签
            g.append("g")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("fill", "#d4af37")
                .style("font-family", "KingHwa_OldSong");
        }
        
        // 其他图表初始化函数...
        // 由于篇幅限制，这里只实现了一个示例图表
        // 实际项目中需要为每个图表编写具体实现
        
        // 初始化进入动画函数
        function initEntranceAnimations() {
            // 主标题动画
            anime({
                targets: '.main-title',
                opacity: [0, 1],
                translateY: [-20, 0],
                duration: 1200,
                easing: 'easeOutExpo'
            });
            
            // 标题点动画
            anime({
                targets: '.main-title .dot',
                scale: [1, 1.5, 1],
                duration: 2000,
                easing: 'easeInOutQuad',
                loop: true,
                delay: 1000
            });
            
            // 标题文字动画
            anime({
                targets: '.main-title span:not(.dot)',
                translateY: [10, 0],
                opacity: [0, 1],
                duration: 1500,
                delay: anime.stagger(200, {start: 800}),
                easing: 'easeOutExpo'
            });
            

            
            // 主内容区域动画
            anime({
                targets: '.main-content',
                opacity: [0, 1],
                translateY: [30, 0],
                duration: 1200,
                easing: 'easeOutQuad',
                delay: 1200
            });
            
            // 创建交叉观察器，用于滚动时触发动画
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // 获取目标元素
                        const target = entry.target;
                        
                        // 根据元素类型应用不同的动画
                        if (target.classList.contains('page-section')) {
                            anime({
                                targets: target,
                                opacity: [0, 1],
                                translateY: [50, 0],
                                duration: 800,
                                easing: 'easeOutQuad'
                            });
                        } else if (target.classList.contains('left-column')) {
                            anime({
                                targets: target,
                                opacity: [0, 1],
                                translateX: [-50, 0],
                                duration: 800,
                                easing: 'easeOutQuad'
                            });
                        } else if (target.classList.contains('right-column')) {
                            anime({
                                targets: target,
                                opacity: [0, 1],
                                translateX: [50, 0],
                                duration: 800,
                                easing: 'easeOutQuad'
                            });
                        } else if (target.classList.contains('center-column')) {
                            anime({
                                targets: target,
                                opacity: [0, 1],
                                scale: [0.9, 1],
                                duration: 800,
                                easing: 'easeOutQuad'
                            });
                        } else if (target.classList.contains('info-vis')) {
                            anime({
                                targets: target,
                                opacity: [0, 1],
                                scale: [0.8, 1],
                                duration: 1000,
                                easing: 'easeOutElastic(1, .5)'
                            });
                        } else if (target.classList.contains('vis-title')) {
                            anime({
                                targets: target,
                                opacity: [0, 1],
                                translateY: [-20, 0],
                                duration: 800,
                                easing: 'easeOutQuad'
                            });
                        } else if (target.classList.contains('main-visual')) {
                            anime({
                                targets: target,
                                opacity: [0, 1],
                                scale: [0.8, 1],
                                duration: 1200,
                                easing: 'easeOutElastic(1, .5)'
                            });
                        } else if (target.classList.contains('instrument-img')) {
                            anime({
                                targets: target,
                                opacity: [0, 1],
                                rotate: [-10, 0],
                                translateX: [-30, 0],
                                duration: 1000,
                                easing: 'easeOutQuad'
                            });
                        }
                        
                        // 动画完成后，取消观察
                        observer.unobserve(target);
                    }
                });
            }, {
                threshold: 0.1 // 当元素10%可见时触发
            });
            
            // 观察所有需要动画的元素
            document.querySelectorAll('.page-section, .left-column, .right-column, .center-column, .info-vis, .vis-title, .main-visual, .instrument-img').forEach(el => {
                observer.observe(el);
            });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 先执行进入动画
            initEntranceAnimations();
            
            // 然后执行其他初始化
            createMusicNotes();
            setupTimelineNav();
            initAllVisualizations();
            
            // 初始化音频播放器
            initAudioPlayer();
        });
        
        function initAudioPlayer() {
            const audioPlayer = document.getElementById('pipaMusicPlayer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const volumeSlider = document.getElementById('volumeSlider');

            document.querySelector('.audio-player-container').appendChild(nowPlaying);
            
            let isPlaying = false;
            
            // 3秒倒计时后自动播放
            function startCountdown() {
                let count = 3;
                nowPlaying.textContent = `即将播放: 琵琶语 (${count})`;
                
                const timer = setInterval(() => {
                    count--;
                    if(count > 0) {
                        nowPlaying.textContent = `即将播放: 琵琶语 (${count})`;
                    } else {
                        clearInterval(timer);
                        startPlaying();
                    }
                }, 1000);
            }
            
            // 开始播放
            function startPlaying() {
                // 设置初始音量
                audioPlayer.volume = volumeSlider.value;
                
                // 开始播放
                audioPlayer.play().then(() => {
                    isPlaying = true;
                    nowPlaying.textContent = '正在播放: 琵琶语';
                    playPauseBtn.textContent = '暂停';
                }).catch(error => {
                    console.error('播放失败:', error);
                });
            }
            
            // 启动倒计时
            startCountdown();
            
            // 播放/暂停控制
            playPauseBtn.addEventListener('click', () => {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    playPauseBtn.textContent = '暂停';
                } else {
                    audioPlayer.pause();
                    playPauseBtn.textContent = '播放';
                }
            });
            
            // 音量控制
            volumeSlider.addEventListener('input', () => {
                if (audioPlayer) {
                    audioPlayer.volume = volumeSlider.value;
                }
            });
        }
    </script>
    
    <!-- 音频播放器 -->
    <div class="audio-player-container">
        <audio id="pipaMusicPlayer" loop>
            <source src="static/img/pipa1.mp3" type="audio/mpeg">
            您的浏览器不支持音频元素。
        </audio>
        <div class="audio-controls">
        </div>
    </div>

    <style>
        .audio-player-container {
            position: fixed;
            bottom: -10px;
            left: 20px;
            width: 100%;
            z-index: 1000;
            pointer-events: none;
            opacity: 0.6; /* 设置透明度为 60% */
        }
        
        .audio-controls {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            pointer-events: auto;
        }
        
        .control-btn {
            background: rgba(212, 175, 55, 0.3);
            left：-50px
            color: #000;
            border: none;
            padding: 5px 15px;
            margin-right: 10px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'KingHwa_OldSong', serif;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(245, 215, 110, 0.5);
            transform: scale(1.05);
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            color: rgba(245, 215, 110, 0.5);
            font-family: 'KingHwa_OldSong', serif;
            pointer-events: auto;
        }
        
        .volume-control span {
            margin-right: 10px;
        }
        
        #volumeSlider {
            width: 80px;
            accent-color: rgba(245, 215, 110, 0.5);
        }
    </style>
    <!-- 底部按钮 -->
    <div class="bottom-buttons" style="flex-direction: row;">
        <button class="bottom-btn" id="playMusic" style="font-family: 'KingHwa_OldSong', serif; font-size: 0.8em; color: white;">播放<br>音乐</button>
        <button class="bottom-btn" id="backToTop" style="font-family: 'KingHwa_OldSong', serif; font-size: 0.8em; color: white;">回到<br>顶部</button>
    </div>
    
    <!-- 音乐可视化器 -->
<!-- 设置容器固定在屏幕下方 -->
<div class="visualizer-container" style="opacity: 0.4; transform: scale(1.4); transform-origin: center; position: fixed; bottom: 0; left: 0; right: 0;"></div>
<canvas id="visualizer"></canvas>
    </div>
    
    <script>
        // 播放音乐
        const audio = new Audio('static/img/pipa1.mp3');
        
        // 初始化音频上下文和可视化
        let audioContext, analyser, dataArray;
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth * 1.5; // 使画布变宽一点
        canvas.height = canvas.offsetHeight;
        
        function initAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaElementSource(audio);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        }
        
        function visualize() {
            requestAnimationFrame(visualize);
            
            if (!analyser) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / analyser.frequencyBinCount) * 2.5;
            let x = 0;
            
            for (let i = 0; i < analyser.frequencyBinCount; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height;
                
                // 修改颜色以适配界面，使用界面主色调相关的颜色范围
                ctx.fillStyle = `hsl(${30 + (i * 1)}, 80%, ${30 + (dataArray[i] / 255) * 30}%)`; 
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
            }
        }
        
        document.getElementById('playMusic').addEventListener('click', () => {
            audio.play();
            if (!audioContext) {
                initAudioContext();
                visualize();
            }
        });
        // 返回顶部
        document.getElementById('backToTop').addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    </script>
</body>
</html>